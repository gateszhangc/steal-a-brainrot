# Supabase 数据库设置 SQL 脚本

请在 Supabase Dashboard 的 SQL Editor 中按顺序执行以下 SQL 语句：

## 1. 创建评论表

```sql
-- 创建评论表（如果不存在）
CREATE TABLE IF NOT EXISTS comments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  author VARCHAR(100) NOT NULL,
  email VARCHAR(255) NOT NULL,
  content TEXT NOT NULL,
  parent_id BIGINT DEFAULT 0,
  game_id VARCHAR(100) NOT NULL DEFAULT 'steal-brainrot',
  status VARCHAR(20) NOT NULL DEFAULT 'approved' CHECK (status IN ('approved', 'pending', 'spam', 'trash')),
  ip_address INET,
  user_agent TEXT,
  like_count INTEGER DEFAULT 0,
  dislike_count INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## 2. 创建索引

```sql
-- 创建索引以提高查询性能
CREATE INDEX IF NOT EXISTS idx_comments_game_id ON comments(game_id);
CREATE INDEX IF NOT EXISTS idx_comments_parent_id ON comments(parent_id);
CREATE INDEX IF NOT EXISTS idx_comments_status ON comments(status);
CREATE INDEX IF NOT EXISTS idx_comments_created_at ON comments(created_at);
```

## 3. 创建更新时间触发器

```sql
-- 创建更新时间函数
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- 创建触发器
DROP TRIGGER IF EXISTS update_comments_updated_at ON comments;
CREATE TRIGGER update_comments_updated_at
    BEFORE UPDATE ON comments
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

## 4. 启用行级安全 (RLS)

```sql
-- 启用 RLS
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;
```

## 5. 创建 RLS 策略

```sql
-- 删除现有策略（如果存在）
DROP POLICY IF EXISTS "Anyone can view approved comments" ON comments;
DROP POLICY IF EXISTS "Anyone can insert comments" ON comments;

-- 创建新策略
CREATE POLICY "Anyone can view approved comments" ON comments
    FOR SELECT USING (status = 'approved');

CREATE POLICY "Anyone can insert comments" ON comments
    FOR INSERT WITH CHECK (true);
```

## 6. 创建投票表

```sql
-- 创建评论投票表
CREATE TABLE IF NOT EXISTS comment_votes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  comment_id BIGINT NOT NULL REFERENCES comments(id) ON DELETE CASCADE,
  ip_address INET NOT NULL,
  vote_type VARCHAR(10) NOT NULL CHECK (vote_type IN ('like', 'dislike')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(comment_id, ip_address)
);
```

## 7. 为投票表创建索引

```sql
-- 为投票表创建索引
CREATE INDEX IF NOT EXISTS idx_comment_votes_comment_id ON comment_votes(comment_id);
CREATE INDEX IF NOT EXISTS idx_comment_votes_ip_address ON comment_votes(ip_address);
```

## 8. 为投票表启用 RLS

```sql
-- 启用投票表的 RLS
ALTER TABLE comment_votes ENABLE ROW LEVEL SECURITY;
```

## 9. 为投票表创建 RLS 策略

```sql
-- 删除现有策略（如果存在）
DROP POLICY IF EXISTS "Anyone can view comment votes" ON comment_votes;
DROP POLICY IF EXISTS "Anyone can insert comment votes" ON comment_votes;

-- 创建新策略
CREATE POLICY "Anyone can view comment votes" ON comment_votes FOR SELECT USING (true);
CREATE POLICY "Anyone can insert comment votes" ON comment_votes FOR INSERT WITH CHECK (true);
```

## 10. 验证表结构

```sql
-- 验证 comments 表结构
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'comments' AND table_schema = 'public'
ORDER BY ordinal_position;

-- 验证 comment_votes 表结构
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'comment_votes' AND table_schema = 'public'
ORDER BY ordinal_position;

-- 检查索引
SELECT indexname, tablename
FROM pg_indexes
WHERE tablename IN ('comments', 'comment_votes') AND schemaname = 'public';
```

## 执行步骤

1. 打开 Supabase Dashboard
2. 进入您的项目
3. 点击左侧菜单的 "SQL Editor"
4. 将上述 SQL 语句复制粘贴到编辑器中
5. 点击 "Run" 执行每个语句块

## 注意事项

- 如果遇到权限错误，请确保您使用的是项目所有者账户
- 如果表已存在，CREATE TABLE IF NOT EXISTS 语句不会覆盖现有数据
- 执行完成后，您应该看到两个表：comments 和 comment_votes
- 确保所有索引都创建成功

## 验证设置

执行完所有 SQL 后，您可以运行以下查询来验证设置：

```sql
-- 检查评论数量
SELECT COUNT(*) as total_comments FROM comments;

-- 检查投票数量
SELECT COUNT(*) as total_votes FROM comment_votes;

-- 查看最新的几条评论
SELECT * FROM comments ORDER BY created_at DESC LIMIT 5;
```

如果以上查询都能正常执行，说明数据库设置成功！