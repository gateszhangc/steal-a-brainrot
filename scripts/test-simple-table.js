import { createClient } from '@supabase/supabase-js'

const supabaseUrl = 'https://ptukqwqbpjzqpqzvlrle.supabase.co'
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0dWtxd3FicGp6cXBxenZscmxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4Mjk3MDksImV4cCI6MjA3ODQwNTcwOX0.PH0-iJiSg7NVgTtNaLzpGisRGgR8iDcRHINI6q0EK7Q'

const supabase = createClient(supabaseUrl, supabaseAnonKey)

async function testTableAccess() {
  try {
    console.log('ğŸ” æµ‹è¯• comments è¡¨è®¿é—®...')

    // å°è¯•æŸ¥è¯¢ comments è¡¨
    const { data, error } = await supabase
      .from('comments')
      .select('count', { count: 'exact', head: true })

    if (error) {
      if (error.code === 'PGRST205') {
        console.log('âŒ comments è¡¨ä¸å­˜åœ¨')
        console.log('')
        console.log('ğŸ“‹ éœ€è¦åœ¨ Supabase Dashboard ä¸­æ‰‹åŠ¨åˆ›å»ºè¡¨')
        console.log('è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š')
        console.log('')
        console.log('1. è®¿é—®: https://supabase.com/dashboard/project/ptukqwqbpjzqpqzvlrle/sql')
        console.log('2. å¤åˆ¶å¹¶ç²˜è´´ä¸‹é¢çš„ SQL ä»£ç ï¼š')
        console.log('')

        // æ˜¾ç¤ºè¦æ‰§è¡Œçš„ SQL
        const sql = `-- åˆ›å»ºè¯„è®ºè¡¨
CREATE TABLE comments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  author VARCHAR(100) NOT NULL,
  email VARCHAR(255) NOT NULL,
  content TEXT NOT NULL,
  parent_id BIGINT DEFAULT 0 REFERENCES comments(id),
  game_id VARCHAR(100) NOT NULL DEFAULT 'steal-brainrot',
  status VARCHAR(20) NOT NULL DEFAULT 'pending' CHECK (status IN ('approved', 'pending', 'spam', 'trash')),
  ip_address INET,
  user_agent TEXT,
  like_count INTEGER DEFAULT 0,
  dislike_count INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_comments_game_id ON comments(game_id);
CREATE INDEX idx_comments_parent_id ON comments(parent_id);
CREATE INDEX idx_comments_status ON comments(status);
CREATE INDEX idx_comments_created_at ON comments(created_at);

-- åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_comments_updated_at
    BEFORE UPDATE ON comments
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- å¯ç”¨ RLS
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;

-- åˆ›å»º RLS ç­–ç•¥
CREATE POLICY "Anyone can view approved comments" ON comments
    FOR SELECT USING (status = 'approved');

CREATE POLICY "Anyone can insert comments" ON comments
    FOR INSERT WITH CHECK (true);

-- åˆ›å»ºè¯„è®ºæŠ•ç¥¨è¡¨
CREATE TABLE comment_votes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  comment_id BIGINT NOT NULL REFERENCES comments(id) ON DELETE CASCADE,
  ip_address INET NOT NULL,
  vote_type VARCHAR(10) NOT NULL CHECK (vote_type IN ('like', 'dislike')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(comment_id, ip_address)
);

-- ä¸ºæŠ•ç¥¨è¡¨åˆ›å»ºç´¢å¼•
CREATE INDEX idx_comment_votes_comment_id ON comment_votes(comment_id);
CREATE INDEX idx_comment_votes_ip_address ON comment_votes(ip_address);

-- RLS for comment_votes
ALTER TABLE comment_votes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view comment votes" ON comment_votes FOR SELECT USING (true);
CREATE POLICY "Anyone can insert comment_votes" ON comment_votes FOR INSERT WITH CHECK (true);`

        console.log(sql)
        console.log('')
        console.log('3. ç‚¹å‡» "Run" æŒ‰é’®æ‰§è¡Œ')
        console.log('4. æ‰§è¡Œå®Œæˆåå‘Šè¯‰æˆ‘ï¼Œæˆ‘ä¼šéªŒè¯è¡¨åˆ›å»ºæˆåŠŸï¼')

      } else {
        console.log('âŒ å…¶ä»–é”™è¯¯:', error)
      }
    } else {
      console.log('âœ… comments è¡¨å·²å­˜åœ¨ï¼')
      console.log('å½“å‰è¯„è®ºæ•°:', data)

      // æµ‹è¯•æ’å…¥ä¸€æ¡ç¤ºä¾‹è¯„è®º
      console.log('\nğŸ§ª æµ‹è¯•æ’å…¥è¯„è®º...')
      const { data: insertData, error: insertError } = await supabase
        .from('comments')
        .insert({
          author: 'æµ‹è¯•ç”¨æˆ·',
          email: 'test@example.com',
          content: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•è¯„è®º',
          game_id: 'steal-brainrot',
          status: 'approved',
          ip_address: '127.0.0.1'
        })
        .select()

      if (insertError) {
        console.log('âŒ æ’å…¥æµ‹è¯•è¯„è®ºå¤±è´¥:', insertError)
      } else {
        console.log('âœ… æµ‹è¯•è¯„è®ºæ’å…¥æˆåŠŸ:', insertData[0])
      }
    }

  } catch (err) {
    console.error('âŒ æµ‹è¯•å¤±è´¥:', err)
  }
}

testTableAccess()