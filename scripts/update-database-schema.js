// Database schema update script
import dotenv from 'dotenv';
dotenv.config({ path: '.env.local' });

import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabase = createClient(supabaseUrl, serviceRoleKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
});

async function updateDatabaseSchema() {
  console.log('ğŸ”§ æ›´æ–°æ•°æ®åº“æ¶æ„...\n');

  // æ£€æŸ¥è¡¨ç»“æ„
  console.log('ğŸ“‹ æ£€æŸ¥å½“å‰è¡¨ç»“æ„...');
  try {
    const { data: columns, error } = await supabase
      .from('information_schema.columns')
      .select('column_name, data_type')
      .eq('table_name', 'comments')
      .eq('table_schema', 'public');

    if (error) {
      console.log('âš ï¸  æ— æ³•ç›´æ¥æ£€æŸ¥è¡¨ç»“æ„ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•...');
    } else {
      const existingColumns = columns.map(col => col.column_name);
      console.log('å½“å‰ columns å­—æ®µ:', existingColumns.join(', '));

      const requiredColumns = ['id', 'author', 'email', 'content', 'parent_id', 'game_id', 'status', 'like_count', 'dislike_count', 'created_at', 'updated_at'];
      const missingColumns = requiredColumns.filter(col => !existingColumns.includes(col));

      if (missingColumns.length > 0) {
        console.log('âŒ ç¼ºå¤±å­—æ®µ:', missingColumns.join(', '));
        console.log('\nğŸ“ è¯·åœ¨ Supabase Dashboard SQL Editor ä¸­æ‰§è¡Œä»¥ä¸‹ SQL:');
      } else {
        console.log('âœ… æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½å­˜åœ¨');
      }
    }
  } catch (e) {
    console.log('âš ï¸  è¡¨ç»“æ„æ£€æŸ¥å¤±è´¥ï¼Œä½¿ç”¨æ‰‹åŠ¨æ–¹æ³•...');
  }

  // æä¾›å®Œæ•´çš„ SQL æ›´æ–°è„šæœ¬
  console.log('\nğŸ”§ ä»¥ä¸‹æ˜¯éœ€è¦æ‰§è¡Œçš„ SQL æ›´æ–°è„šæœ¬:\n');

  console.log('-- 1. æ·»åŠ ç¼ºå¤±å­—æ®µåˆ° comments è¡¨');
  console.log('ALTER TABLE comments ADD COLUMN IF NOT EXISTS parent_id BIGINT DEFAULT 0;');
  console.log('ALTER TABLE comments ADD COLUMN IF NOT EXISTS game_id VARCHAR(100) NOT NULL DEFAULT \'steal-brainrot\';');
  console.log('ALTER TABLE comments ADD COLUMN IF NOT EXISTS status VARCHAR(20) NOT NULL DEFAULT \'approved\' CHECK (status IN (\'approved\', \'pending\', \'spam\', \'trash\'));');
  console.log('ALTER TABLE comments ADD COLUMN IF NOT EXISTS ip_address INET;');
  console.log('ALTER TABLE comments ADD COLUMN IF NOT EXISTS user_agent TEXT;');
  console.log('ALTER TABLE comments ADD COLUMN IF NOT EXISTS like_count INTEGER DEFAULT 0;');
  console.log('ALTER TABLE comments ADD COLUMN IF NOT EXISTS dislike_count INTEGER DEFAULT 0;');
  console.log('ALTER TABLE comments ADD COLUMN IF NOT EXISTS updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();');

  console.log('\n-- 2. åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨');
  console.log('CREATE OR REPLACE FUNCTION update_updated_at_column()');
  console.log('RETURNS TRIGGER AS $$');
  console.log('BEGIN');
  console.log('    NEW.updated_at = NOW();');
  console.log('    RETURN NEW;');
  console.log('END;');
  console.log('$$ language \'plpgsql\';');

  console.log('\nDROP TRIGGER IF EXISTS update_comments_updated_at ON comments;');
  console.log('CREATE TRIGGER update_comments_updated_at');
  console.log('    BEFORE UPDATE ON comments');
  console.log('    FOR EACH ROW');
  console.log('    EXECUTE FUNCTION update_updated_at_column();');

  console.log('\n-- 3. åˆ›å»ºç´¢å¼•');
  console.log('CREATE INDEX IF NOT EXISTS idx_comments_game_id ON comments(game_id);');
  console.log('CREATE INDEX IF NOT EXISTS idx_comments_parent_id ON comments(parent_id);');
  console.log('CREATE INDEX IF NOT EXISTS idx_comments_status ON comments(status);');
  console.log('CREATE INDEX IF NOT EXISTS idx_comments_created_at ON comments(created_at);');

  console.log('\n-- 4. åˆ›å»º comment_votes è¡¨');
  console.log('CREATE TABLE IF NOT EXISTS comment_votes (');
  console.log('  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,');
  console.log('  comment_id BIGINT NOT NULL REFERENCES comments(id) ON DELETE CASCADE,');
  console.log('  ip_address INET NOT NULL,');
  console.log('  vote_type VARCHAR(10) NOT NULL CHECK (vote_type IN (\'like\', \'dislike\')),');
  console.log('  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),');
  console.log('  UNIQUE(comment_id, ip_address)');
  console.log(');');

  console.log('\n-- 5. ä¸º comment_votes è¡¨åˆ›å»ºç´¢å¼•');
  console.log('CREATE INDEX IF NOT EXISTS idx_comment_votes_comment_id ON comment_votes(comment_id);');
  console.log('CREATE INDEX IF NOT EXISTS idx_comment_votes_ip_address ON comment_votes(ip_address);');

  console.log('\n-- 6. å¯ç”¨ RLS');
  console.log('ALTER TABLE comments ENABLE ROW LEVEL SECURITY;');
  console.log('ALTER TABLE comment_votes ENABLE ROW LEVEL SECURITY;');

  console.log('\n-- 7. åˆ›å»º RLS ç­–ç•¥');
  console.log('DROP POLICY IF EXISTS "Anyone can view approved comments" ON comments;');
  console.log('CREATE POLICY "Anyone can view approved comments" ON comments');
  console.log('    FOR SELECT USING (status = \'approved\');');

  console.log('DROP POLICY IF EXISTS "Anyone can insert comments" ON comments;');
  console.log('CREATE POLICY "Anyone can insert comments" ON comments');
  console.log('    FOR INSERT WITH CHECK (true);');

  console.log('DROP POLICY IF EXISTS "Anyone can view comment votes" ON comment_votes;');
  console.log('CREATE POLICY "Anyone can view comment votes" ON comment_votes');
  console.log('    FOR SELECT USING (true);');

  console.log('DROP POLICY IF EXISTS "Anyone can insert comment votes" ON comment_votes;');
  console.log('CREATE POLICY "Anyone can insert comment votes" ON comment_votes');
  console.log('    FOR INSERT WITH CHECK (true);');

  // æµ‹è¯•å½“å‰åŠŸèƒ½
  console.log('\nğŸ§ª æµ‹è¯•å½“å‰åŠŸèƒ½...');
  try {
    const { data, error } = await supabase
      .from('comments')
      .select('count')
      .single();

    if (error) {
      console.log('âŒ åŸºæœ¬åŠŸèƒ½æµ‹è¯•å¤±è´¥:', error.message);
    } else {
      console.log('âœ… åŸºæœ¬åŠŸèƒ½æ­£å¸¸');
      console.log(`ğŸ“Š å½“å‰è¯„è®ºæ•°é‡: ${data.count}`);
    }
  } catch (e) {
    console.log('âŒ åŠŸèƒ½æµ‹è¯•å¤±è´¥:', e.message);
  }

  console.log('\nğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ:');
  console.log('1. å¤åˆ¶ä¸Šè¿° SQL è¯­å¥');
  console.log('2. åœ¨ Supabase Dashboard çš„ SQL Editor ä¸­æ‰§è¡Œ');
  console.log('3. è¿è¡Œ node scripts/standalone-test.js é‡æ–°æµ‹è¯•');
  console.log('4. å¯åŠ¨å¼€å‘æœåŠ¡å™¨: npm run dev');
}

// è¿è¡Œæ›´æ–°è„šæœ¬
updateDatabaseSchema();