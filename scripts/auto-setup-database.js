// Automated database setup for Supabase comments system
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
dotenv.config({ path: '.env.local' });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !serviceRoleKey) {
  console.error('âŒ ç¼ºå°‘ Supabase ç¯å¢ƒå˜é‡');
  process.exit(1);
}

// ä½¿ç”¨æœåŠ¡è§’è‰²å¯†é’¥åˆ›å»ºå®¢æˆ·ç«¯
const supabase = createClient(supabaseUrl, serviceRoleKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
});

async function executeSQL(sql, description) {
  console.log(`ğŸ”„ ${description}...`);
  try {
    // ä½¿ç”¨ PostgreSQL å®¢æˆ·ç«¯ç›´æ¥æ‰§è¡Œ SQL
    const { error } = await supabase.rpc('exec', { sql });
    if (error) {
      console.log(`âš ï¸  ${description} å¯èƒ½éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ:`, error.message);
      return false;
    }
    console.log(`âœ… ${description} å®Œæˆ`);
    return true;
  } catch (e) {
    console.log(`âš ï¸  ${description} å¯èƒ½éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ:`, e.message);
    return false;
  }
}

async function autoSetupDatabase() {
  console.log('ğŸš€ è‡ªåŠ¨è®¾ç½® Supabase è¯„è®ºç³»ç»Ÿæ•°æ®åº“...\n');

  const sqlCommands = [
    {
      sql: `
        CREATE TABLE IF NOT EXISTS comments (
          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          author VARCHAR(100) NOT NULL,
          email VARCHAR(255) NOT NULL,
          content TEXT NOT NULL,
          parent_id BIGINT DEFAULT 0,
          game_id VARCHAR(100) NOT NULL DEFAULT 'steal-brainrot',
          status VARCHAR(20) NOT NULL DEFAULT 'approved' CHECK (status IN ('approved', 'pending', 'spam', 'trash')),
          ip_address INET,
          user_agent TEXT,
          like_count INTEGER DEFAULT 0,
          dislike_count INTEGER DEFAULT 0,
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
      `,
      description: 'åˆ›å»º comments è¡¨'
    },
    {
      sql: 'CREATE INDEX IF NOT EXISTS idx_comments_game_id ON comments(game_id);',
      description: 'åˆ›å»º game_id ç´¢å¼•'
    },
    {
      sql: 'CREATE INDEX IF NOT EXISTS idx_comments_parent_id ON comments(parent_id);',
      description: 'åˆ›å»º parent_id ç´¢å¼•'
    },
    {
      sql: 'CREATE INDEX IF NOT EXISTS idx_comments_status ON comments(status);',
      description: 'åˆ›å»º status ç´¢å¼•'
    },
    {
      sql: 'CREATE INDEX IF NOT EXISTS idx_comments_created_at ON comments(created_at);',
      description: 'åˆ›å»º created_at ç´¢å¼•'
    }
  ];

  // æ‰§è¡Œè¡¨å’Œç´¢å¼•åˆ›å»º
  let successCount = 0;
  for (const command of sqlCommands) {
    if (await executeSQL(command.sql, command.description)) {
      successCount++;
    }
  }

  console.log(`\nğŸ“Š è‡ªåŠ¨å®Œæˆ: ${successCount}/${sqlCommands.length} ä¸ªæ“ä½œ`);

  // æ£€æŸ¥è¡¨æ˜¯å¦å·²å­˜åœ¨å¹¶å¯è®¿é—®
  console.log('\nğŸ” æ£€æŸ¥è¡¨çŠ¶æ€...');
  try {
    const { data, error } = await supabase
      .from('comments')
      .select('count')
      .single();

    if (error) {
      console.log('âŒ è¡¨ä¸å¯è®¿é—®ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œ SQL');
    } else {
      console.log('âœ… comments è¡¨å¯è®¿é—®');
      console.log(`ğŸ“Š å½“å‰è¯„è®ºæ•°é‡: ${data.count || 0}`);
    }
  } catch (e) {
    console.log('âŒ è¡¨æ£€æŸ¥å¤±è´¥:', e.message);
  }

  // æµ‹è¯•æ’å…¥ä¸€æ¡è¯„è®º
  console.log('\nğŸ§ª æµ‹è¯•æ•°æ®æ’å…¥...');
  try {
    const testComment = {
      author: 'System Test',
      email: 'test@system.com',
      content: 'è¿™æ˜¯ä¸€æ¡ç³»ç»Ÿæµ‹è¯•è¯„è®ºï¼Œç”¨äºéªŒè¯æ•°æ®åº“è¿æ¥ã€‚',
      game_id: 'test-setup'
    };

    const { data, error } = await supabase
      .from('comments')
      .insert(testComment)
      .select()
      .single();

    if (error) {
      console.log('âŒ æµ‹è¯•æ’å…¥å¤±è´¥:', error.message);
    } else {
      console.log('âœ… æµ‹è¯•æ’å…¥æˆåŠŸ, ID:', data.id);

      // ç«‹å³åˆ é™¤æµ‹è¯•æ•°æ®
      await supabase.from('comments').delete().eq('id', data.id);
      console.log('âœ… æµ‹è¯•æ•°æ®å·²æ¸…ç†');
    }
  } catch (e) {
    console.log('âŒ æµ‹è¯•æ’å…¥å¤±è´¥:', e.message);
  }

  console.log('\nğŸ“‹ æ€»ç»“:');
  if (successCount === sqlCommands.length) {
    console.log('ğŸ‰ æ‰€æœ‰æ•°æ®åº“è®¾ç½®éƒ½å·²å®Œæˆï¼');
  } else {
    console.log('âš ï¸  éƒ¨åˆ†è®¾ç½®éœ€è¦æ‰‹åŠ¨å®Œæˆ');
    console.log('è¯·å‚è€ƒ DATABASE_SETUP_SQL.md æ–‡ä»¶å®Œæˆå‰©ä½™è®¾ç½®');
  }

  console.log('\nğŸš€ ä¸‹ä¸€æ­¥:');
  console.log('1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨: npm run dev');
  console.log('2. è¿è¡Œ API æµ‹è¯•: node scripts/test-api-endpoints.js');
  console.log('3. è®¿é—®ç½‘ç«™æµ‹è¯•è¯„è®ºåŠŸèƒ½');
}

// è¿è¡Œè‡ªåŠ¨è®¾ç½®
autoSetupDatabase();