import puppeteer from 'playwright'

async function createTablesViaDashboard() {
  console.log('ğŸš€ å°è¯•é€šè¿‡è‡ªåŠ¨åŒ–æ–¹å¼åœ¨ Supabase Dashboard ä¸­åˆ›å»ºè¡¨...')

  const browser = await puppeteer.chromium.launch({ headless: false })
  const context = await browser.newContext()
  const page = await context.newPage()

  try {
    // è®¿é—® Supabase Dashboard
    console.log('ğŸ”— è®¿é—® Supabase Dashboard...')
    await page.goto('https://supabase.com/dashboard/project/ptukqwqbpjzqpqzvlrle/sql')

    // ç­‰å¾…ç”¨æˆ·ç™»å½•ï¼ˆå¦‚æœéœ€è¦ï¼‰
    console.log('â³ ç­‰å¾…é¡µé¢åŠ è½½...')
    await page.waitForTimeout(3000)

    // æ£€æŸ¥æ˜¯å¦å·²ç»ç™»å½•
    const loginRequired = await page.locator('text=Sign in to your account').isVisible()

    if (loginRequired) {
      console.log('âŒ éœ€è¦æ‰‹åŠ¨ç™»å½• Supabase Dashboard')
      console.log('ğŸ“‹ è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ‰‹åŠ¨æ“ä½œï¼š')
      console.log('1. è®¿é—®: https://supabase.com/dashboard/project/ptukqwqbpjzqpqzvlrle/sql')
      console.log('2. å¤åˆ¶ FINAL_SQL_TO_RUN.sql ä¸­çš„å†…å®¹')
      console.log('3. ç²˜è´´åˆ° SQL Editor å¹¶ç‚¹å‡» Run')
      await browser.close()
      return
    }

    // æ£€æŸ¥æ˜¯å¦åœ¨ SQL Editor é¡µé¢
    const sqlEditorVisible = await page.locator('.monaco-editor').isVisible()

    if (sqlEditorVisible) {
      console.log('âœ… æ‰¾åˆ° SQL Editor')

      // è¯»å– SQL æ–‡ä»¶å†…å®¹
      const fs = await import('fs')
      const path = await import('path')
      const __dirname = path.dirname(new URL(import.meta.url).pathname)
      const sqlPath = path.join(__dirname, '..', 'FINAL_SQL_TO_RUN.sql')

      let sqlContent
      try {
        sqlContent = fs.readFileSync(sqlPath, 'utf8')
      } catch (err) {
        console.log('âŒ æ— æ³•è¯»å– SQL æ–‡ä»¶ï¼Œä½¿ç”¨åŸºæœ¬ SQL')
        sqlContent = `CREATE TABLE IF NOT EXISTS comments (
          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          author VARCHAR(100) NOT NULL,
          email VARCHAR(255) NOT NULL,
          content TEXT NOT NULL,
          game_id VARCHAR(100) NOT NULL DEFAULT 'steal-brainrot',
          status VARCHAR(20) NOT NULL DEFAULT 'pending',
          ip_address INET,
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );`
      }

      // æ¸…ç©ºå¹¶ç²˜è´´ SQL
      console.log('ğŸ“ ç²˜è´´ SQL å†…å®¹...')
      await page.keyboard.press('Control+a')
      await page.keyboard.type(sqlContent)

      // ç­‰å¾…ä¸€ä¸‹
      await page.waitForTimeout(1000)

      // ç‚¹å‡» Run æŒ‰é’®
      console.log('â–¶ï¸ æ‰§è¡Œ SQL...')
      const runButton = page.locator('button:has-text("Run")').first()
      await runButton.click()

      // ç­‰å¾…æ‰§è¡Œå®Œæˆ
      await page.waitForTimeout(5000)

      // æ£€æŸ¥ç»“æœ
      const resultsVisible = await page.locator('.query-results').isVisible()
      if (resultsVisible) {
        console.log('âœ… SQL æ‰§è¡Œå®Œæˆ!')
      } else {
        console.log('âŒ SQL æ‰§è¡Œå¯èƒ½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç»“æœ')
      }

    } else {
      console.log('âŒ æœªæ‰¾åˆ° SQL Editor')
    }

  } catch (error) {
    console.error('âŒ è‡ªåŠ¨åŒ–æ“ä½œå¤±è´¥:', error.message)
  } finally {
    await browser.close()
  }
}

// æ£€æŸ¥ Playwright æ˜¯å¦å¯ç”¨
try {
  createTablesViaDashboard()
} catch (error) {
  console.log('âŒ Playwright ä¸å¯ç”¨ï¼Œè¯·æ‰‹åŠ¨åˆ›å»ºè¡¨')
  console.log('\nğŸ“‹ æ‰‹åŠ¨æ“ä½œæ­¥éª¤ï¼š')
  console.log('1. è®¿é—®: https://supabase.com/dashboard/project/ptukqwqbpjzqpqzvlrle/sql')
  console.log('2. å¤åˆ¶ FINAL_SQL_TO_RUN.sql ä¸­çš„å†…å®¹')
  console.log('3. ç²˜è´´åˆ° SQL Editor å¹¶ç‚¹å‡» Run')
}