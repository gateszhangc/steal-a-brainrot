import { createClient } from '@supabase/supabase-js'

// ç›´æ¥ä½¿ç”¨ç¯å¢ƒå˜é‡
const supabaseUrl = 'https://ptukqwqbpjzqpqzvlrle.supabase.co'
const serviceRoleKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0dWtxd3FicGp6cXBxenZscmxlIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MjgyOTcwOSwiZXhwIjoyMDc4NDA1NzA5fQ.OtYT3SuQgbACbWOR6hHAEsKNqkUhMEOcb7d-QqSnXTc'

console.log('ğŸ”§ ä½¿ç”¨ Service Role Key åˆ›å»ºæ•°æ®è¡¨')
console.log('URL:', supabaseUrl)
console.log('Key exists:', !!serviceRoleKey)

if (!supabaseUrl || !serviceRoleKey) {
  console.error('âŒ ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯')
  process.exit(1)
}

// ä½¿ç”¨ service role key åˆ›å»ºå®¢æˆ·ç«¯ï¼ˆå…·æœ‰ç®¡ç†å‘˜æƒé™ï¼‰
const supabase = createClient(supabaseUrl, serviceRoleKey)

async function createTablesWithServiceKey() {
  try {
    console.log('\nğŸš€ å¼€å§‹åˆ›å»ºæ•°æ®è¡¨...')

    // é¦–å…ˆæ£€æŸ¥è¡¨æ˜¯å¦å·²å­˜åœ¨
    const { data: existingTables, error: checkError } = await supabase
      .from('comments')
      .select('count', { count: 'exact', head: true })

    if (!checkError) {
      console.log('âœ… comments è¡¨å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º')
    } else {
      console.log('ğŸ“‹ comments è¡¨ä¸å­˜åœ¨ï¼Œå¼€å§‹åˆ›å»º...')

      // è¯»å– SQL æ–‡ä»¶
      const fs = await import('fs')
      const path = await import('path')
      const __dirname = path.dirname(new URL(import.meta.url).pathname)
      const sqlPath = path.join(__dirname, '..', 'supabase', 'comments_table.sql')

      let sql
      try {
        sql = fs.readFileSync(sqlPath, 'utf8')
      } catch (err) {
        console.log('âŒ æ— æ³•è¯»å– SQL æ–‡ä»¶ï¼Œä½¿ç”¨å†…è” SQL')
        sql = `-- åˆ›å»ºè¯„è®ºè¡¨
CREATE TABLE comments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  author VARCHAR(100) NOT NULL,
  email VARCHAR(255) NOT NULL,
  content TEXT NOT NULL,
  parent_id BIGINT DEFAULT 0 REFERENCES comments(id),
  game_id VARCHAR(100) NOT NULL DEFAULT 'steal-brainrot',
  status VARCHAR(20) NOT NULL DEFAULT 'pending' CHECK (status IN ('approved', 'pending', 'spam', 'trash')),
  ip_address INET,
  user_agent TEXT,
  like_count INTEGER DEFAULT 0,
  dislike_count INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_comments_game_id ON comments(game_id);
CREATE INDEX idx_comments_parent_id ON comments(parent_id);
CREATE INDEX idx_comments_status ON comments(status);
CREATE INDEX idx_comments_created_at ON comments(created_at);

-- åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_comments_updated_at
    BEFORE UPDATE ON comments
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- å¯ç”¨ RLS
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;

-- åˆ›å»º RLS ç­–ç•¥
CREATE POLICY "Anyone can view approved comments" ON comments
    FOR SELECT USING (status = 'approved');

CREATE POLICY "Anyone can insert comments" ON comments
    FOR INSERT WITH CHECK (true);

-- åˆ›å»ºè¯„è®ºæŠ•ç¥¨è¡¨
CREATE TABLE comment_votes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  comment_id BIGINT NOT NULL REFERENCES comments(id) ON DELETE CASCADE,
  ip_address INET NOT NULL,
  vote_type VARCHAR(10) NOT NULL CHECK (vote_type IN ('like', 'dislike')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(comment_id, ip_address)
);

-- ä¸ºæŠ•ç¥¨è¡¨åˆ›å»ºç´¢å¼•
CREATE INDEX idx_comment_votes_comment_id ON comment_votes(comment_id);
CREATE INDEX idx_comment_votes_ip_address ON comment_votes(ip_address);

-- RLS for comment_votes
ALTER TABLE comment_votes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view comment votes" ON comment_votes FOR SELECT USING (true);
CREATE POLICY "Anyone can insert comment votes" ON comment_votes FOR INSERT WITH CHECK (true);`
      }

      // ä½¿ç”¨ RPC æ‰§è¡Œ SQL - æ³¨æ„ï¼šService role key éœ€è¦ç‰¹æ®Šçš„å¤„ç†æ–¹å¼
      console.log('ğŸ“ æ‰§è¡Œ SQL è¯­å¥...')
      console.log('SQL é•¿åº¦:', sql.length, 'å­—ç¬¦')

      // å°è¯•é€šè¿‡ç›´æ¥ SQL æ‰§è¡Œï¼ˆæŸäº› Supabase ç‰ˆæœ¬æ”¯æŒï¼‰
      const { data: execData, error: execError } = await supabase
        .rpc('exec_sql', { sql_string: sql })

      if (execError) {
        console.log('âš ï¸ RPC æ‰§è¡Œå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•...')
        console.log('é”™è¯¯:', execError.message)

        // å¦‚æœ RPC ä¸å¯ç”¨ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡å…¶ä»–æ–¹å¼éªŒè¯
        console.log('\nğŸ” éªŒè¯è¡¨æ˜¯å¦å·²å­˜åœ¨...')
      } else {
        console.log('âœ… SQL æ‰§è¡ŒæˆåŠŸ:', execData)
      }
    }

    // éªŒè¯è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
    console.log('\nğŸ” éªŒè¯ comments è¡¨...')
    const { data: verifyData, error: verifyError } = await supabase
      .from('comments')
      .select('count', { count: 'exact', head: true })

    if (verifyError) {
      console.log('âŒ è¡¨éªŒè¯å¤±è´¥:', verifyError)
      console.log('å¯èƒ½éœ€è¦æ‰‹åŠ¨åœ¨ Supabase Dashboard ä¸­æ‰§è¡Œ SQL')
    } else {
      console.log('âœ… comments è¡¨åˆ›å»º/éªŒè¯æˆåŠŸ!')
      console.log('å½“å‰è¯„è®ºæ•°:', verifyData)

      // æµ‹è¯•æ’å…¥ä¸€æ¡è¯„è®º
      console.log('\nğŸ§ª æµ‹è¯•æ’å…¥è¯„è®º...')
      const { data: insertData, error: insertError } = await supabase
        .from('comments')
        .insert({
          author: 'ç³»ç»Ÿæµ‹è¯•',
          email: 'system@example.com',
          content: 'è¿™æ˜¯ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºçš„æµ‹è¯•è¯„è®º',
          game_id: 'steal-brainrot',
          status: 'approved',
          ip_address: '127.0.0.1'
        })
        .select()

      if (insertError) {
        console.log('âŒ æ’å…¥æµ‹è¯•è¯„è®ºå¤±è´¥:', insertError)
      } else {
        console.log('âœ… æµ‹è¯•è¯„è®ºæ’å…¥æˆåŠŸ!')
        console.log('è¯„è®ºID:', insertData[0].id)
        console.log('ä½œè€…:', insertData[0].author)
        console.log('å†…å®¹:', insertData[0].content)
      }
    }

    // æ£€æŸ¥ comment_votes è¡¨
    console.log('\nğŸ” éªŒè¯ comment_votes è¡¨...')
    const { data: votesData, error: votesError } = await supabase
      .from('comment_votes')
      .select('count', { count: 'exact', head: true })

    if (votesError) {
      console.log('âŒ comment_votes è¡¨éªŒè¯å¤±è´¥:', votesError)
    } else {
      console.log('âœ… comment_votes è¡¨åˆ›å»º/éªŒè¯æˆåŠŸ!')
      console.log('å½“å‰æŠ•ç¥¨æ•°:', votesData)
    }

  } catch (err) {
    console.error('âŒ åˆ›å»ºè¡¨æ—¶å‡ºé”™:', err)
  }
}

createTablesWithServiceKey()