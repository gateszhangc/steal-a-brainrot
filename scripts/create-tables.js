import { createClient } from '@supabase/supabase-js'

const supabaseUrl = 'https://ptukqwqbpjzqpqzvlrle.supabase.co'
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0dWtxd3FicGp6cXBxenZscmxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4Mjk3MDksImV4cCI6MjA3ODQwNTcwOX0.PH0-iJiSg7NVgTtNaLzpGisRGgR8iDcRHINI6q0EK7Q'

const supabase = createClient(supabaseUrl, supabaseAnonKey)

// SQL è¯­å¥
const createTablesSQL = `
-- åˆ›å»ºè¯„è®ºè¡¨
CREATE TABLE IF NOT EXISTS comments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  author VARCHAR(100) NOT NULL,
  email VARCHAR(255) NOT NULL,
  content TEXT NOT NULL,
  parent_id BIGINT DEFAULT 0 REFERENCES comments(id),
  game_id VARCHAR(100) NOT NULL DEFAULT 'steal-brainrot',
  status VARCHAR(20) NOT NULL DEFAULT 'pending' CHECK (status IN ('approved', 'pending', 'spam', 'trash')),
  ip_address INET,
  user_agent TEXT,
  like_count INTEGER DEFAULT 0,
  dislike_count INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_comments_game_id ON comments(game_id);
CREATE INDEX IF NOT EXISTS idx_comments_parent_id ON comments(parent_id);
CREATE INDEX IF NOT EXISTS idx_comments_status ON comments(status);
CREATE INDEX IF NOT EXISTS idx_comments_created_at ON comments(created_at);

-- åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨å‡½æ•°
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- åˆ›å»ºè§¦å‘å™¨
DROP TRIGGER IF EXISTS update_comments_updated_at ON comments;
CREATE TRIGGER update_comments_updated_at
    BEFORE UPDATE ON comments
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- å¯ç”¨ RLS
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;

-- åˆ é™¤å·²å­˜åœ¨çš„ç­–ç•¥
DROP POLICY IF EXISTS "Anyone can view approved comments" ON comments;
DROP POLICY IF EXISTS "Anyone can insert comments" ON comments;
DROP POLICY IF EXISTS "Users can update own comments" ON comments;

-- åˆ›å»ºæ–°çš„ RLS ç­–ç•¥
CREATE POLICY "Anyone can view approved comments" ON comments
    FOR SELECT USING (status = 'approved');

CREATE POLICY "Anyone can insert comments" ON comments
    FOR INSERT WITH CHECK (true);

CREATE POLICY "Users can update own comments" ON comments
    FOR UPDATE USING (auth.uid()::text = email);

-- åˆ›å»ºè¯„è®ºæŠ•ç¥¨è¡¨
CREATE TABLE IF NOT EXISTS comment_votes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  comment_id BIGINT NOT NULL REFERENCES comments(id) ON DELETE CASCADE,
  ip_address INET NOT NULL,
  vote_type VARCHAR(10) NOT NULL CHECK (vote_type IN ('like', 'dislike')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(comment_id, ip_address)
);

-- ä¸ºæŠ•ç¥¨è¡¨åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_comment_votes_comment_id ON comment_votes(comment_id);
CREATE INDEX IF NOT EXISTS idx_comment_votes_ip_address ON comment_votes(ip_address);

-- RLS for comment_votes
ALTER TABLE comment_votes ENABLE ROW LEVEL SECURITY;

-- åˆ é™¤å·²å­˜åœ¨çš„æŠ•ç¥¨ç­–ç•¥
DROP POLICY IF EXISTS "Anyone can view comment votes" ON comment_votes;
DROP POLICY IF EXISTS "Anyone can insert comment votes" ON comment_votes;

-- åˆ›å»ºæŠ•ç¥¨è¡¨ç­–ç•¥
CREATE POLICY "Anyone can view comment votes" ON comment_votes FOR SELECT USING (true);
CREATE POLICY "Anyone can insert comment votes" ON comment_votes FOR INSERT WITH CHECK (true);
`

async function createTables() {
  try {
    console.log('ğŸš€ å¼€å§‹åˆ›å»ºæ•°æ®è¡¨...')

    // ä½¿ç”¨ RPC æ‰§è¡Œ SQL (Supabase éœ€è¦ä½¿ç”¨ service role key æ¥æ‰§è¡Œ DDL)
    // ä½†æ˜¯ anon key å¯èƒ½æ— æ³•æ‰§è¡Œ DDLï¼Œæˆ‘ä»¬å…ˆå°è¯•ä¸€ä¸‹

    // é¦–å…ˆæµ‹è¯•èƒ½å¦æŸ¥è¯¢ç³»ç»Ÿè¡¨æ¥éªŒè¯æƒé™
    const { data: tables, error: tablesError } = await supabase
      .from('information_schema.tables')
      .select('table_name')
      .eq('table_schema', 'public')
      .eq('table_name', 'comments')

    console.log('æ£€æŸ¥ comments è¡¨æ˜¯å¦å­˜åœ¨:', { tables, tablesError })

    if (tablesError && tablesError.code === 'PGRST205') {
      console.log('âš ï¸  anon key æ— æ³•æ‰§è¡Œç³»ç»ŸæŸ¥è¯¢ï¼Œéœ€è¦ service role key')
      console.log('è¯·ä» Supabase Dashboard è·å– service role key')
      return false
    }

    // å¦‚æœå¯ä»¥æŸ¥è¯¢ï¼Œå°è¯•æ’å…¥æµ‹è¯•æ•°æ®æ¥éªŒè¯è¡¨æ˜¯å¦å­˜åœ¨
    const { data: testInsert, error: testError } = await supabase
      .from('comments')
      .select('count', { count: 'exact', head: true })

    if (testError) {
      if (testError.code === 'PGRST205') {
        console.log('ğŸ“‹ comments è¡¨ä¸å­˜åœ¨ï¼Œéœ€è¦åœ¨ Supabase Dashboard ä¸­æ‰‹åŠ¨åˆ›å»º')
        console.log('è¯·è®¿é—® https://supabase.com/dashboard/project/ptukqwqbpjzqpqzvlrle/sql')
        console.log('ç„¶åç²˜è´´ä»¥ä¸‹ SQLï¼š')
        console.log('=' .repeat(50))
        console.log(createTablesSQL)
        console.log('=' .repeat(50))
      } else {
        console.log('âŒ æµ‹è¯•å¤±è´¥:', testError)
      }
    } else {
      console.log('âœ… comments è¡¨å·²å­˜åœ¨ï¼å½“å‰è¯„è®ºæ•°:', testInsert)
    }

  } catch (err) {
    console.error('âŒ åˆ›å»ºè¡¨æ—¶å‡ºé”™:', err)
  }
}

createTables()