// Database setup script for Supabase comments system
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
dotenv.config({ path: '.env.local' });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !serviceRoleKey) {
  console.error('âŒ ç¼ºå°‘ Supabase ç¯å¢ƒå˜é‡');
  console.log('è¯·æ£€æŸ¥ .env.local æ–‡ä»¶ä¸­çš„ä»¥ä¸‹å˜é‡:');
  console.log('- NEXT_PUBLIC_SUPABASE_URL');
  console.log('- SUPABASE_SERVICE_ROLE_KEY');
  process.exit(1);
}

// ä½¿ç”¨æœåŠ¡è§’è‰²å¯†é’¥åˆ›å»ºå®¢æˆ·ç«¯ï¼ˆç»•è¿‡ RLSï¼‰
const supabase = createClient(supabaseUrl, serviceRoleKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
});

async function setupDatabase() {
  console.log('ğŸš€ å¼€å§‹è®¾ç½® Supabase è¯„è®ºç³»ç»Ÿæ•°æ®åº“...\n');

  try {
    // 1. åˆ›å»º comments è¡¨
    console.log('1. åˆ›å»º comments è¡¨...');
    const { error: commentsError } = await supabase.rpc('exec_sql', {
      sql: `
        CREATE TABLE IF NOT EXISTS comments (
          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          author VARCHAR(100) NOT NULL,
          email VARCHAR(255) NOT NULL,
          content TEXT NOT NULL,
          parent_id BIGINT DEFAULT 0,
          game_id VARCHAR(100) NOT NULL DEFAULT 'steal-brainrot',
          status VARCHAR(20) NOT NULL DEFAULT 'approved' CHECK (status IN ('approved', 'pending', 'spam', 'trash')),
          ip_address INET,
          user_agent TEXT,
          like_count INTEGER DEFAULT 0,
          dislike_count INTEGER DEFAULT 0,
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
      `
    });

    // å¦‚æœ RPC ä¸å¯ç”¨ï¼Œå°è¯•ç›´æ¥ SQL
    if (commentsError) {
      console.log('âš ï¸  RPC ä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•åˆ›å»ºè¡¨...');
      // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ‰‹åŠ¨åœ¨ Supabase Dashboard æ‰§è¡Œ SQL
      console.log('è¯·åœ¨ Supabase Dashboard çš„ SQL Editor ä¸­æ‰§è¡Œä»¥ä¸‹ SQL:');
      console.log(`
-- åˆ›å»ºè¯„è®ºè¡¨
CREATE TABLE IF NOT EXISTS comments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  author VARCHAR(100) NOT NULL,
  email VARCHAR(255) NOT NULL,
  content TEXT NOT NULL,
  parent_id BIGINT DEFAULT 0,
  game_id VARCHAR(100) NOT NULL DEFAULT 'steal-brainrot',
  status VARCHAR(20) NOT NULL DEFAULT 'approved' CHECK (status IN ('approved', 'pending', 'spam', 'trash')),
  ip_address INET,
  user_agent TEXT,
  like_count INTEGER DEFAULT 0,
  dislike_count INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
      `);
    } else {
      console.log('âœ… comments è¡¨åˆ›å»ºæˆåŠŸ');
    }

    // 2. åˆ›å»ºç´¢å¼•
    console.log('\n2. åˆ›å»ºç´¢å¼•...');
    const indexSQLs = [
      'CREATE INDEX IF NOT EXISTS idx_comments_game_id ON comments(game_id);',
      'CREATE INDEX IF NOT EXISTS idx_comments_parent_id ON comments(parent_id);',
      'CREATE INDEX IF NOT EXISTS idx_comments_status ON comments(status);',
      'CREATE INDEX IF NOT EXISTS idx_comments_created_at ON comments(created_at);'
    ];

    for (const sql of indexSQLs) {
      try {
        const { error: indexError } = await supabase.rpc('exec_sql', { sql });
        if (indexError) {
          console.log(`âš ï¸  ç´¢å¼•åˆ›å»ºå¯èƒ½éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ: ${sql}`);
        }
      } catch (e) {
        console.log(`âš ï¸  ç´¢å¼•åˆ›å»ºå¯èƒ½éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ: ${sql}`);
      }
    }

    // 3. åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨
    console.log('\n3. åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨...');
    const triggerSQL = `
      CREATE OR REPLACE FUNCTION update_updated_at_column()
      RETURNS TRIGGER AS $$
      BEGIN
          NEW.updated_at = NOW();
          RETURN NEW;
      END;
      $$ language 'plpgsql';

      DROP TRIGGER IF EXISTS update_comments_updated_at ON comments;
      CREATE TRIGGER update_comments_updated_at
          BEFORE UPDATE ON comments
          FOR EACH ROW
          EXECUTE FUNCTION update_updated_at_column();
    `;

    try {
      const { error: triggerError } = await supabase.rpc('exec_sql', { sql: triggerSQL });
      if (triggerError) {
        console.log('âš ï¸  è§¦å‘å™¨åˆ›å»ºå¯èƒ½éœ€è¦æ‰‹åŠ¨æ‰§è¡Œï¼Œè¯·åœ¨ SQL Editor ä¸­è¿è¡Œ:');
        console.log(triggerSQL);
      } else {
        console.log('âœ… æ›´æ–°æ—¶é—´è§¦å‘å™¨åˆ›å»ºæˆåŠŸ');
      }
    } catch (e) {
      console.log('âš ï¸  è§¦å‘å™¨åˆ›å»ºå¯èƒ½éœ€è¦æ‰‹åŠ¨æ‰§è¡Œï¼Œè¯·åœ¨ SQL Editor ä¸­è¿è¡Œ:');
      console.log(triggerSQL);
    }

    // 4. å¯ç”¨ RLS
    console.log('\n4. å¯ç”¨è¡Œçº§å®‰å…¨ (RLS)...');
    try {
      const { error: rlsError } = await supabase.rpc('exec_sql', {
        sql: 'ALTER TABLE comments ENABLE ROW LEVEL SECURITY;'
      });
      if (rlsError) {
        console.log('âš ï¸  RLS å¯ç”¨å¯èƒ½éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ: ALTER TABLE comments ENABLE ROW LEVEL SECURITY;');
      } else {
        console.log('âœ… RLS å·²å¯ç”¨');
      }
    } catch (e) {
      console.log('âš ï¸  RLS å¯ç”¨å¯èƒ½éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ: ALTER TABLE comments ENABLE ROW LEVEL SECURITY;');
    }

    // 5. åˆ›å»º RLS ç­–ç•¥
    console.log('\n5. åˆ›å»º RLS ç­–ç•¥...');
    const rlsPolicies = [
      'DROP POLICY IF EXISTS "Anyone can view approved comments" ON comments;',
      'CREATE POLICY "Anyone can view approved comments" ON comments FOR SELECT USING (status = \'approved\');',
      'DROP POLICY IF EXISTS "Anyone can insert comments" ON comments;',
      'CREATE POLICY "Anyone can insert comments" ON comments FOR INSERT WITH CHECK (true);'
    ];

    for (const policy of rlsPolicies) {
      try {
        const { error: policyError } = await supabase.rpc('exec_sql', { sql: policy });
        if (policyError && !policyError.message.includes('does not exist')) {
          console.log(`âš ï¸  ç­–ç•¥å¯èƒ½éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ: ${policy}`);
        }
      } catch (e) {
        console.log(`âš ï¸  ç­–ç•¥å¯èƒ½éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ: ${policy}`);
      }
    }

    // 6. åˆ›å»º comment_votes è¡¨
    console.log('\n6. åˆ›å»º comment_votes è¡¨...');
    const votesTableSQL = `
      CREATE TABLE IF NOT EXISTS comment_votes (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        comment_id BIGINT NOT NULL REFERENCES comments(id) ON DELETE CASCADE,
        ip_address INET NOT NULL,
        vote_type VARCHAR(10) NOT NULL CHECK (vote_type IN ('like', 'dislike')),
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        UNIQUE(comment_id, ip_address)
      );

      -- ä¸ºæŠ•ç¥¨è¡¨åˆ›å»ºç´¢å¼•
      CREATE INDEX IF NOT EXISTS idx_comment_votes_comment_id ON comment_votes(comment_id);
      CREATE INDEX IF NOT EXISTS idx_comment_votes_ip_address ON comment_votes(ip_address);

      -- RLS for comment_votes
      ALTER TABLE comment_votes ENABLE ROW LEVEL SECURITY;

      DROP POLICY IF EXISTS "Anyone can view comment votes" ON comment_votes;
      CREATE POLICY "Anyone can view comment votes" ON comment_votes FOR SELECT USING (true);

      DROP POLICY IF EXISTS "Anyone can insert comment votes" ON comment_votes;
      CREATE POLICY "Anyone can insert comment votes" ON comment_votes FOR INSERT WITH CHECK (true);
    `;

    console.log('è¯·åœ¨ Supabase Dashboard çš„ SQL Editor ä¸­æ‰§è¡Œä»¥ä¸‹ SQL æ¥åˆ›å»ºæŠ•ç¥¨è¡¨:');
    console.log(votesTableSQL);

    // 7. æµ‹è¯•è¡¨è¿æ¥
    console.log('\n7. æµ‹è¯•è¡¨è¿æ¥...');
    try {
      const { data, error } = await supabase
        .from('comments')
        .select('count')
        .single();

      if (error) {
        console.log('âŒ è¡¨è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œè¯·ç¡®è®¤è¡¨å·²åˆ›å»º:', error.message);
      } else {
        console.log('âœ… è¡¨è¿æ¥æµ‹è¯•æˆåŠŸ');
        console.log(`ğŸ“Š å½“å‰è¯„è®ºæ•°é‡: ${data.count || 0}`);
      }
    } catch (e) {
      console.log('âŒ è¡¨è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œè¯·ç¡®è®¤è¡¨å·²åˆ›å»º:', e.message);
    }

    console.log('\nğŸ‰ æ•°æ®åº“è®¾ç½®è„šæœ¬æ‰§è¡Œå®Œæˆ!');
    console.log('\nğŸ“ ä¸‹ä¸€æ­¥æ“ä½œ:');
    console.log('1. è®¿é—® Supabase Dashboard');
    console.log('2. è¿›å…¥ SQL Editor');
    console.log('3. æ‰§è¡Œä¸Šè¿° SQL è¯­å¥åˆ›å»ºè¡¨å’Œç´¢å¼•');
    console.log('4. è¿è¡Œ npm run dev å¯åŠ¨å¼€å‘æœåŠ¡å™¨');
    console.log('5. è¿è¡Œ node scripts/test-api-endpoints.js æµ‹è¯• API');

  } catch (error) {
    console.error('âŒ è®¾ç½®è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
    process.exit(1);
  }
}

// è¿è¡Œè®¾ç½®è„šæœ¬
setupDatabase();