import { createClient } from '@supabase/supabase-js'

const supabaseUrl = 'https://ptukqwqbpjzqpqzvlrle.supabase.co'
const serviceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0dWtxd3FicGp6cXBxenZscmxlIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MjgyOTcwOSwiZXhwIjoyMDc4NDA1NzA5fQ.OtYT3SuQgbACbWOR6hHAEsKNqkUhMEOcb7d-QqSnXTc'

// ä½¿ç”¨ service role key åˆ›å»ºç®¡ç†å‘˜å®¢æˆ·ç«¯
const supabase = createClient(supabaseUrl, serviceKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
})

console.log('ğŸš€ ç›´æ¥ä½¿ç”¨ Service Role Key åˆ›å»ºæ•°æ®è¡¨...')

async function createTablesDirectly() {
  try {
    // SQL è¯­å¥
    const sqlStatements = [
      // 1. åˆ›å»ºè¯„è®ºè¡¨
      `CREATE TABLE IF NOT EXISTS comments (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        author VARCHAR(100) NOT NULL,
        email VARCHAR(255) NOT NULL,
        content TEXT NOT NULL,
        parent_id BIGINT DEFAULT 0,
        game_id VARCHAR(100) NOT NULL DEFAULT 'steal-brainrot',
        status VARCHAR(20) NOT NULL DEFAULT 'pending' CHECK (status IN ('approved', 'pending', 'spam', 'trash')),
        ip_address INET,
        user_agent TEXT,
        like_count INTEGER DEFAULT 0,
        dislike_count INTEGER DEFAULT 0,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
      );`,

      // 2. åˆ›å»ºç´¢å¼•
      `CREATE INDEX IF NOT EXISTS idx_comments_game_id ON comments(game_id);`,
      `CREATE INDEX IF NOT EXISTS idx_comments_parent_id ON comments(parent_id);`,
      `CREATE INDEX IF NOT EXISTS idx_comments_status ON comments(status);`,
      `CREATE INDEX IF NOT EXISTS idx_comments_created_at ON comments(created_at);`,

      // 3. åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨å‡½æ•°
      `CREATE OR REPLACE FUNCTION update_updated_at_column()
      RETURNS TRIGGER AS $$
      BEGIN
          NEW.updated_at = NOW();
          RETURN NEW;
      END;
      $$ language 'plpgsql';`,

      // 4. åˆ›å»ºè§¦å‘å™¨
      `DROP TRIGGER IF EXISTS update_comments_updated_at ON comments;`,
      `CREATE TRIGGER update_comments_updated_at
          BEFORE UPDATE ON comments
          FOR EACH ROW
          EXECUTE FUNCTION update_updated_at_column();`,

      // 5. å¯ç”¨ RLS
      `ALTER TABLE comments ENABLE ROW LEVEL SECURITY;`,

      // 6. åˆ é™¤å·²å­˜åœ¨çš„ç­–ç•¥
      `DROP POLICY IF EXISTS "Anyone can view approved comments" ON comments;`,
      `DROP POLICY IF EXISTS "Anyone can insert comments" ON comments;`,
      `DROP POLICY IF EXISTS "Users can update own comments" ON comments;`,

      // 7. åˆ›å»º RLS ç­–ç•¥
      `CREATE POLICY "Anyone can view approved comments" ON comments
          FOR SELECT USING (status = 'approved');`,

      `CREATE POLICY "Anyone can insert comments" ON comments
          FOR INSERT WITH CHECK (true);`,

      `CREATE POLICY "Users can update own comments" ON comments
          FOR UPDATE USING (auth.uid()::text = email);`,

      // 8. åˆ›å»ºè¯„è®ºæŠ•ç¥¨è¡¨
      `CREATE TABLE IF NOT EXISTS comment_votes (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        comment_id BIGINT NOT NULL,
        ip_address INET NOT NULL,
        vote_type VARCHAR(10) NOT NULL CHECK (vote_type IN ('like', 'dislike')),
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        UNIQUE(comment_id, ip_address)
      );`,

      // 9. æ·»åŠ å¤–é”®çº¦æŸï¼ˆå¦‚æœè¡¨å·²å­˜åœ¨å¯èƒ½éœ€è¦å•ç‹¬å¤„ç†ï¼‰
      `DO $$
      BEGIN
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'comment_votes' AND table_schema = 'public') THEN
          ALTER TABLE comment_votes
          ADD CONSTRAINT IF NOT EXISTS fk_comment_votes_comment_id
          FOREIGN KEY (comment_id) REFERENCES comments(id) ON DELETE CASCADE;
        END IF;
      END $$;`,

      // 10. ä¸ºæŠ•ç¥¨è¡¨åˆ›å»ºç´¢å¼•
      `CREATE INDEX IF NOT EXISTS idx_comment_votes_comment_id ON comment_votes(comment_id);`,
      `CREATE INDEX IF NOT EXISTS idx_comment_votes_ip_address ON comment_votes(ip_address);`,

      // 11. RLS for comment_votes
      `ALTER TABLE comment_votes ENABLE ROW LEVEL SECURITY;`,

      // 12. åˆ é™¤å·²å­˜åœ¨çš„æŠ•ç¥¨ç­–ç•¥
      `DROP POLICY IF EXISTS "Anyone can view comment votes" ON comment_votes;`,
      `DROP POLICY IF EXISTS "Anyone can insert comment votes" ON comment_votes;`,

      // 13. åˆ›å»ºæŠ•ç¥¨è¡¨ç­–ç•¥
      `CREATE POLICY "Anyone can view comment votes" ON comment_votes FOR SELECT USING (true);`,
      `CREATE POLICY "Anyone can insert comment votes" ON comment_votes FOR INSERT WITH CHECK (true);`,

      // 14. æ’å…¥ä¸€æ¡æµ‹è¯•è¯„è®º
      `INSERT INTO comments (author, email, content, game_id, status, ip_address)
      VALUES ('ç³»ç»Ÿæµ‹è¯•', 'system@test.com', 'è¡¨åˆ›å»ºåçš„æµ‹è¯•è¯„è®º', 'steal-brainrot', 'approved', '127.0.0.1')
      ON CONFLICT DO NOTHING
      RETURNING id, author, created_at;`
    ]

    console.log(`\nğŸ“‹ å‡†å¤‡æ‰§è¡Œ ${sqlStatements.length} æ¡ SQL è¯­å¥...`)

    // å°è¯•é€šè¿‡ç›´æ¥ HTTP è¯·æ±‚æ‰§è¡Œ SQLï¼ˆSupabase æ”¯æŒï¼‰
    for (let i = 0; i < sqlStatements.length; i++) {
      const sql = sqlStatements[i]
      console.log(`\nğŸ”§ æ‰§è¡Œè¯­å¥ ${i + 1}/${sqlStatements.length}:`)
      console.log(sql.substring(0, 100) + (sql.length > 100 ? '...' : ''))

      try {
        // ä½¿ç”¨ Supabase çš„ RPC åŠŸèƒ½æ‰§è¡Œ SQL
        const { data, error } = await supabase.rpc('exec_sql', {
          sql_string: sql
        })

        if (error) {
          // å¦‚æœ RPC ä¸å¯ç”¨ï¼Œå°è¯•å…¶ä»–æ–¹æ³•
          console.log(`âš ï¸ RPC å¤±è´¥: ${error.message}`)

          // å°è¯•é€šè¿‡ç›´æ¥ REST API
          const response = await fetch(`${supabaseUrl}/rest/v1/rpc/exec_sql`, {
            method: 'POST',
            headers: {
              'apikey': serviceKey,
              'Authorization': `Bearer ${serviceKey}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              sql_string: sql
            })
          })

          if (response.ok) {
            const result = await response.text()
            console.log(`âœ… REST API æ‰§è¡ŒæˆåŠŸ: ${result}`)
          } else {
            console.log(`âŒ REST API ä¹Ÿå¤±è´¥: ${response.status}`)
          }
        } else {
          console.log(`âœ… RPC æ‰§è¡ŒæˆåŠŸ:`, data)
        }
      } catch (err) {
        console.log(`âŒ æ‰§è¡Œå¤±è´¥: ${err.message}`)
      }
    }

    // éªŒè¯è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
    console.log('\nğŸ” éªŒè¯è¡¨åˆ›å»ºç»“æœ...')

    // æ£€æŸ¥ comments è¡¨
    const { data: commentsData, error: commentsError } = await supabase
      .from('comments')
      .select('count', { count: 'exact', head: true })

    if (commentsError) {
      console.log('âŒ comments è¡¨éªŒè¯å¤±è´¥:', commentsError)
    } else {
      console.log('âœ… comments è¡¨åˆ›å»ºæˆåŠŸ! å½“å‰è¯„è®ºæ•°:', commentsData)
    }

    // æ£€æŸ¥ comment_votes è¡¨
    const { data: votesData, error: votesError } = await supabase
      .from('comment_votes')
      .select('count', { count: 'exact', head: true })

    if (votesError) {
      console.log('âŒ comment_votes è¡¨éªŒè¯å¤±è´¥:', votesError)
    } else {
      console.log('âœ… comment_votes è¡¨åˆ›å»ºæˆåŠŸ! å½“å‰æŠ•ç¥¨æ•°:', votesData)
    }

    console.log('\nğŸ‰ è¡¨åˆ›å»ºæ“ä½œå®Œæˆ!')

  } catch (err) {
    console.error('âŒ åˆ›å»ºè¡¨æ—¶å‘ç”Ÿé”™è¯¯:', err)
  }
}

createTablesDirectly()