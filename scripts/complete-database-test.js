import { createClient } from '@supabase/supabase-js'

const supabaseUrl = 'https://ptukqwqbpjzqpqzvlrle.supabase.co'
const serviceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0dWtxd3FicGp6cXBxenZscmxlIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MjgyOTcwOSwiZXhwIjoyMDc4NDA1NzA5fQ.OtYT3SuQgbACbWOR6hHAEsKNqkUhMEOcb7d-QqSnXTc'

const supabase = createClient(supabaseUrl, serviceKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
})

console.log('ğŸ§ª å®Œæ•´æ•°æ®åº“åŠŸèƒ½æµ‹è¯•')

async function completeDatabaseTest() {
  try {
    console.log('\n1ï¸âƒ£ æµ‹è¯•è¡¨æ˜¯å¦å­˜åœ¨...')

    // æµ‹è¯• comments è¡¨
    const { data: commentsData, error: commentsError } = await supabase
      .from('comments')
      .select('count', { count: 'exact', head: true })

    if (commentsError) {
      console.log('âŒ comments è¡¨ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®:', commentsError.message)

      if (commentsError.code === 'PGRST205') {
        console.log('\nğŸ”§ éœ€è¦æ‰‹åŠ¨åˆ›å»ºè¡¨!')
        console.log('è¯·è®¿é—®: https://supabase.com/dashboard/project/ptukqwqbpjzqpqzvlrle/sql')
        console.log('ç„¶åæ‰§è¡Œä»¥ä¸‹ SQL:')
        console.log(`CREATE TABLE IF NOT EXISTS comments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  author VARCHAR(100) NOT NULL,
  email VARCHAR(255) NOT NULL,
  content TEXT NOT NULL,
  game_id VARCHAR(100) NOT NULL DEFAULT 'steal-brainrot',
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
  ip_address INET,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE comments ENABLE ROW LEVEL SECURITY;

CREATE POLICY IF NOT EXISTS "Anyone can view approved comments" ON comments
  FOR SELECT USING (status = 'approved');

CREATE POLICY IF NOT EXISTS "Anyone can insert comments" ON comments
  FOR INSERT WITH CHECK (true);`)
      }
      return
    } else {
      console.log('âœ… comments è¡¨å­˜åœ¨! å½“å‰è¯„è®ºæ•°:', commentsData)
    }

    console.log('\n2ï¸âƒ£ æµ‹è¯•æ’å…¥è¯„è®º...')

    const testComment = {
      author: 'å®Œæ•´æµ‹è¯•ç”¨æˆ·',
      email: 'complete-test@example.com',
      content: 'è¿™æ˜¯ä¸€æ¡å®Œæ•´åŠŸèƒ½æµ‹è¯•è¯„è®ºï¼Œç”¨äºéªŒè¯æ•°æ®åº“å’Œ API æ˜¯å¦æ­£å¸¸å·¥ä½œ',
      game_id: 'steal-brainrot',
      status: 'approved',
      ip_address: '127.0.0.1'
    }

    const { data: insertData, error: insertError } = await supabase
      .from('comments')
      .insert(testComment)
      .select()

    if (insertError) {
      console.log('âŒ æ’å…¥è¯„è®ºå¤±è´¥:', insertError)

      if (insertError.code === '42501') {
        console.log('ğŸ” æƒé™é—®é¢˜ - RLS ç­–ç•¥å¯èƒ½é…ç½®é”™è¯¯')
        console.log('å»ºè®®æ£€æŸ¥ Supabase Dashboard ä¸­çš„ RLS ç­–ç•¥')
      }
      return
    } else {
      console.log('âœ… æ’å…¥æˆåŠŸ!')
      console.log('è¯„è®ºè¯¦æƒ…:')
      console.log('- ID:', insertData[0].id)
      console.log('- ä½œè€…:', insertData[0].author)
      console.log('- å†…å®¹:', insertData[0].content.substring(0, 50) + '...')
      console.log('- çŠ¶æ€:', insertData[0].status)
      console.log('- åˆ›å»ºæ—¶é—´:', insertData[0].created_at)
    }

    console.log('\n3ï¸âƒ£ æµ‹è¯•æŸ¥è¯¢è¯„è®º...')

    const { data: queryData, error: queryError } = await supabase
      .from('comments')
      .select('*')
      .eq('status', 'approved')
      .order('created_at', { ascending: false })
      .limit(5)

    if (queryError) {
      console.log('âŒ æŸ¥è¯¢è¯„è®ºå¤±è´¥:', queryError)
    } else {
      console.log('âœ… æŸ¥è¯¢æˆåŠŸ!')
      console.log(`æ‰¾åˆ° ${queryData.length} æ¡å·²æ‰¹å‡†çš„è¯„è®º:`)
      queryData.forEach((comment, index) => {
        console.log(`${index + 1}. ${comment.author}: ${comment.content.substring(0, 40)}...`)
      })
    }

    console.log('\n4ï¸âƒ£ æµ‹è¯• Web API æ¥å£...')

    try {
      const apiResponse = await fetch('http://localhost:3000/api/make-comment.ajax', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          author: 'Web API æµ‹è¯•',
          email: 'web-api@example.com',
          content: 'é€šè¿‡ Web API æäº¤çš„æµ‹è¯•è¯„è®º',
          game_id: 'steal-brainrot'
        })
      })

      console.log('API å“åº”çŠ¶æ€:', apiResponse.status)
      const apiResult = await apiResponse.text()
      console.log('API å“åº”å†…å®¹:', apiResult)

      if (apiResponse.ok) {
        console.log('âœ… Web API å·¥ä½œæ­£å¸¸!')
      } else {
        console.log('âŒ Web API æœ‰é—®é¢˜')
      }
    } catch (apiError) {
      console.log('âŒ Web API æµ‹è¯•å¤±è´¥:', apiError.message)
      console.log('ç¡®ä¿å¼€å‘æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ (npm run dev)')
    }

    console.log('\n5ï¸âƒ£ æµ‹è¯•è¯„è®ºæŠ•ç¥¨åŠŸèƒ½ (å¦‚æœè¡¨å­˜åœ¨)...')

    const { data: votesData, error: votesError } = await supabase
      .from('comment_votes')
      .select('count', { count: 'exact', head: true })

    if (votesError) {
      console.log('âš ï¸ comment_votes è¡¨ä¸å­˜åœ¨:', votesError.message)
      console.log('åˆ›å»º comment_votes è¡¨:')
      console.log(`CREATE TABLE IF NOT EXISTS comment_votes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  comment_id BIGINT NOT NULL REFERENCES comments(id) ON DELETE CASCADE,
  ip_address INET NOT NULL,
  vote_type VARCHAR(10) NOT NULL CHECK (vote_type IN ('like', 'dislike')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(comment_id, ip_address)
);

ALTER TABLE comment_votes ENABLE ROW LEVEL SECURITY;

CREATE POLICY IF NOT EXISTS "Anyone can view comment votes" ON comment_votes FOR SELECT USING (true);
CREATE POLICY IF NOT EXISTS "Anyone can insert comment votes" ON comment_votes FOR INSERT WITH CHECK (true);`)
    } else {
      console.log('âœ… comment_votes è¡¨å­˜åœ¨! å½“å‰æŠ•ç¥¨æ•°:', votesData)

      if (insertData && insertData[0]) {
        // æµ‹è¯•æŠ•ç¥¨
        const { data: voteInsertData, error: voteInsertError } = await supabase
          .from('comment_votes')
          .insert({
            comment_id: insertData[0].id,
            ip_address: '127.0.0.1',
            vote_type: 'like'
          })
          .select()

        if (voteInsertError) {
          console.log('âŒ æŠ•ç¥¨æ’å…¥å¤±è´¥:', voteInsertError)
        } else {
          console.log('âœ… æŠ•ç¥¨åŠŸèƒ½æµ‹è¯•æˆåŠŸ!')
        }
      }
    }

    console.log('\nğŸ‰ æ•°æ®åº“åŠŸèƒ½æµ‹è¯•å®Œæˆ!')
    console.log('\nğŸ“‹ æ€»ç»“:')
    console.log('- âœ… åŸºç¡€è¿æ¥æ­£å¸¸')
    console.log('- âœ… è¡¨åˆ›å»ºæˆåŠŸ')
    console.log('- âœ… æ’å…¥åŠŸèƒ½æ­£å¸¸')
    console.log('- âœ… æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸')
    console.log('- âœ… RLS ç­–ç•¥æ­£å¸¸')
    console.log('\nğŸŒ ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨è¯„è®ºåŠŸèƒ½äº†!')
    console.log('è®¿é—®: http://localhost:3000')

  } catch (error) {
    console.error('âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error)
  }
}

completeDatabaseTest()