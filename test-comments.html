<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯„è®ºç³»ç»Ÿæµ‹è¯•é¡µé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-4">
        <h1 class="text-3xl font-bold text-gray-900 mb-8 text-center">è¯„è®ºç³»ç»Ÿæµ‹è¯•</h1>

        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">æµ‹è¯•è¯´æ˜</h2>
            <ul class="list-disc list-inside space-y-2 text-gray-600">
                <li>ç‚¹å‡»"å‘è¡¨è¯„è®º"æŒ‰é’®æµ‹è¯•è¯„è®ºæäº¤åŠŸèƒ½</li>
                <li>å¡«å†™å§“åã€é‚®ç®±å’Œè¯„è®ºå†…å®¹</li>
                <li>æµ‹è¯•å›å¤åŠŸèƒ½ï¼ˆç‚¹å‡»è¯„è®ºçš„å›å¤æŒ‰é’®ï¼‰</li>
                <li>æµ‹è¯•æŠ•ç¥¨åŠŸèƒ½ï¼ˆç‚¹èµ/ç‚¹è¸©ï¼‰</li>
                <li>æµ‹è¯•åˆ†é¡µå’Œæ’åºåŠŸèƒ½</li>
            </ul>
        </div>

        <!-- è¯„è®ºç³»ç»Ÿå®¹å™¨ -->
        <div id="comments-container" class="bg-white rounded-lg shadow-sm">
            <!-- è¯„è®ºç³»ç»Ÿå°†åœ¨è¿™é‡ŒåŠ è½½ -->
            <div class="p-6 text-center text-gray-500">
                <div class="loading inline-block w-6 h-6 border-2 border-gray-300 border-t-blue-600 rounded-full"></div>
                <p class="mt-2">æ­£åœ¨åŠ è½½è¯„è®ºç³»ç»Ÿ...</p>
            </div>
        </div>
    </div>

    <script>
        // è¯„è®ºç³»ç»ŸJavaScript
        class CommentsSystem {
            constructor(containerId, gameId = 'comments-demo') {
                this.container = document.getElementById(containerId);
                this.gameId = gameId;
                this.comments = [];
                this.page = 1;
                this.totalPages = 1;
                this.sort = 'newest';
                this.replyingTo = null;

                this.loadComments();
            }

            async loadComments() {
                try {
                    const response = await fetch(
                        `/api/comments.ajax?game_id=${this.gameId}&page=${this.page}&limit=5&sort=${this.sort}`
                    );
                    const data = await response.json();

                    if (data.success) {
                        this.comments = data.comments;
                        this.totalPages = data.pagination.totalPages;
                        this.render();
                    } else {
                        this.showError('åŠ è½½è¯„è®ºå¤±è´¥');
                    }
                } catch (error) {
                    console.error('åŠ è½½è¯„è®ºé”™è¯¯:', error);
                    this.showError('åŠ è½½è¯„è®ºå¤±è´¥');
                }
            }

            async submitComment(formData) {
                try {
                    const response = await fetch('/api/make-comment.ajax', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ...formData,
                            game_id: this.gameId
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.hideCommentForm();
                        this.loadComments();
                        alert('è¯„è®ºæäº¤æˆåŠŸï¼');
                    } else {
                        alert('æäº¤å¤±è´¥: ' + data.error);
                    }
                } catch (error) {
                    console.error('æäº¤è¯„è®ºé”™è¯¯:', error);
                    alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }

            async vote(commentId, voteType) {
                try {
                    const response = await fetch('/api/comment-vote.ajax', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            comment_id: commentId,
                            vote_type: voteType
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.updateVoteCounts(commentId, data.counts);
                    } else {
                        console.error('æŠ•ç¥¨å¤±è´¥:', data.error);
                    }
                } catch (error) {
                    console.error('æŠ•ç¥¨é”™è¯¯:', error);
                }
            }

            updateVoteCounts(commentId, counts) {
                const updateComment = (comment) => {
                    if (comment.id === commentId) {
                        comment.like_count = counts.like;
                        comment.dislike_count = counts.dislike;
                    }
                    if (comment.replies) {
                        comment.replies.forEach(updateComment);
                    }
                };

                this.comments.forEach(updateComment);
                this.render();
            }

            showCommentForm(parentId = 0) {
                const formHtml = `
                    <div class="comment-form bg-gray-50 p-4 rounded-md">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" id="comment-author" placeholder="å§“å *" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <input type="email" id="comment-email" placeholder="é‚®ç®± *" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <textarea id="comment-content" placeholder="${parentId ? 'å›å¤è¯„è®º...' : 'å†™ä¸‹ä½ çš„è¯„è®º...'}" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" required></textarea>
                        <div class="flex items-center justify-end mt-4 space-x-3">
                            ${parentId ? '<button onclick="commentsSystem.hideCommentForm()" class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆå›å¤</button>' : ''}
                            <button onclick="commentsSystem.handleSubmit()" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">æäº¤è¯„è®º</button>
                        </div>
                    </div>
                `;

                this.replyingTo = parentId;
                this.render();

                const formContainer = this.container.querySelector('.comment-form');
                if (formContainer) {
                    // è‡ªåŠ¨èšç„¦åˆ°å†…å®¹è¾“å…¥æ¡†
                    const contentInput = document.getElementById('comment-content');
                    if (contentInput) contentInput.focus();
                }
            }

            hideCommentForm() {
                this.replyingTo = null;
                this.render();
            }

            handleSubmit() {
                const author = document.getElementById('comment-author').value.trim();
                const email = document.getElementById('comment-email').value.trim();
                const content = document.getElementById('comment-content').value.trim();

                if (!author || !email || !content) {
                    alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                    return;
                }

                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                    return;
                }

                this.submitComment({
                    author,
                    email,
                    content,
                    parent_id: this.replyingTo
                });
            }

            showError(message) {
                this.container.innerHTML = `
                    <div class="p-6 text-center text-red-500">
                        <p>${message}</p>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">é‡æ–°åŠ è½½</button>
                    </div>
                `;
            }

            render() {
                let html = `
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">è¯„è®º (${this.comments.length})</h3>

                        <div class="flex items-center justify-between mb-4">
                            <button onclick="commentsSystem.showCommentForm()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                ${this.replyingTo ? 'å–æ¶ˆ' : 'å‘è¡¨è¯„è®º'}
                            </button>

                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600">æ’åº:</span>
                                <select onchange="commentsSystem.changeSort(this.value)" class="text-sm border border-gray-300 rounded-md px-3 py-1">
                                    <option value="newest" ${this.sort === 'newest' ? 'selected' : ''}>æœ€æ–°</option>
                                    <option value="oldest" ${this.sort === 'oldest' ? 'selected' : ''}>æœ€æ—©</option>
                                    <option value="popular" ${this.sort === 'popular' ? 'selected' : ''}>æœ€çƒ­é—¨</option>
                                </select>
                            </div>
                        </div>

                        ${this.replyingTo !== null ? this.getCommentForm() : ''}
                    </div>
                `;

                if (this.comments.length === 0) {
                    html += `
                        <div class="p-6 text-center text-gray-500">
                            æš‚æ— è¯„è®ºï¼Œæ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼
                        </div>
                    `;
                } else {
                    html += '<div class="p-6">';

                    this.comments.forEach(comment => {
                        html += this.renderComment(comment);
                    });

                    html += '</div>';

                    // åˆ†é¡µ
                    if (this.totalPages > 1) {
                        html += `
                            <div class="flex items-center justify-center space-x-2 p-6 border-t border-gray-200">
                                <button onclick="commentsSystem.changePage(${this.page - 1})"
                                        ${this.page === 1 ? 'disabled' : ''}
                                        class="px-3 py-1 border border-gray-300 rounded-md disabled:opacity-50 hover:bg-gray-50">
                                    ä¸Šä¸€é¡µ
                                </button>
                                <span class="text-sm text-gray-600">ç¬¬ ${this.page} é¡µï¼Œå…± ${this.totalPages} é¡µ</span>
                                <button onclick="commentsSystem.changePage(${this.page + 1})"
                                        ${this.page === this.totalPages ? 'disabled' : ''}
                                        class="px-3 py-1 border border-gray-300 rounded-md disabled:opacity-50 hover:bg-gray-50">
                                    ä¸‹ä¸€é¡µ
                                </button>
                            </div>
                        `;
                    }
                }

                this.container.innerHTML = html;
            }

            renderComment(comment) {
                return `
                    <div class="border-b border-gray-100 last:border-b-0 pb-6 last:pb-0">
                        <div class="flex items-start space-x-3">
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-2">
                                        <span class="font-medium text-gray-900">${comment.author}</span>
                                        <span class="text-sm text-gray-500">${comment.date || 'åˆšåˆš'}</span>
                                    </div>
                                </div>

                                <div class="text-gray-800 mb-3 whitespace-pre-wrap">${comment.content}</div>

                                <div class="flex items-center space-x-4">
                                    <div class="flex items-center space-x-2">
                                        <button onclick="commentsSystem.vote(${comment.id}, 'like')"
                                                class="flex items-center space-x-1 px-3 py-1 text-sm rounded-full border border-gray-300 hover:bg-gray-50">
                                            <span>ğŸ‘</span>
                                            <span>${comment.like_count || 0}</span>
                                        </button>
                                        <button onclick="commentsSystem.vote(${comment.id}, 'dislike')"
                                                class="flex items-center space-x-1 px-3 py-1 text-sm rounded-full border border-gray-300 hover:bg-gray-50">
                                            <span>ğŸ‘</span>
                                            <span>${comment.dislike_count || 0}</span>
                                        </button>
                                    </div>

                                    <button onclick="commentsSystem.showCommentForm(${comment.id})"
                                            class="text-sm text-blue-600 hover:text-blue-700">
                                        å›å¤
                                    </button>
                                </div>

                                ${comment.replies && comment.replies.length > 0 ? this.renderReplies(comment.replies) : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderReplies(replies) {
                return `
                    <div class="mt-4 space-y-4 pl-6 border-l-2 border-gray-200">
                        ${replies.map(reply => `
                            <div>
                                <div class="flex items-start space-x-3">
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center space-x-2">
                                                <span class="font-medium text-gray-900">${reply.author}</span>
                                                <span class="text-sm text-gray-500">${reply.date || 'åˆšåˆš'}</span>
                                            </div>
                                        </div>

                                        <div class="text-gray-800 mb-2 whitespace-pre-wrap">${reply.content}</div>

                                        <div class="flex items-center space-x-2">
                                            <button onclick="commentsSystem.vote(${reply.id}, 'like')"
                                                    class="flex items-center space-x-1 px-2 py-1 text-sm rounded border border-gray-300 hover:bg-gray-50">
                                                <span>ğŸ‘</span>
                                                <span>${reply.like_count || 0}</span>
                                            </button>
                                            <button onclick="commentsSystem.vote(${reply.id}, 'dislike')"
                                                    class="flex items-center space-x-1 px-2 py-1 text-sm rounded border border-gray-300 hover:bg-gray-50">
                                                <span>ğŸ‘</span>
                                                <span>${reply.dislike_count || 0}</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            getCommentForm() {
                return `
                    <div class="comment-form bg-gray-50 p-4 rounded-md mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" id="comment-author" placeholder="å§“å *" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <input type="email" id="comment-email" placeholder="é‚®ç®± *" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <textarea id="comment-content" placeholder="${this.replyingTo ? 'å›å¤è¯„è®º...' : 'å†™ä¸‹ä½ çš„è¯„è®º...'}" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" required></textarea>
                        <div class="flex items-center justify-end mt-4 space-x-3">
                            ${this.replyingTo ? '<button onclick="commentsSystem.hideCommentForm()" class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆå›å¤</button>' : ''}
                            <button onclick="commentsSystem.handleSubmit()" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">æäº¤è¯„è®º</button>
                        </div>
                    </div>
                `;
            }

            changeSort(sort) {
                this.sort = sort;
                this.page = 1;
                this.loadComments();
            }

            changePage(page) {
                if (page >= 1 && page <= this.totalPages) {
                    this.page = page;
                    this.loadComments();
                }
            }
        }

        // åˆå§‹åŒ–è¯„è®ºç³»ç»Ÿ
        const commentsSystem = new CommentsSystem('comments-container');
    </script>
</body>
</html>