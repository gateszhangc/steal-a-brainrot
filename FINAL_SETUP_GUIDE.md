# Supabase è¯„è®ºç³»ç»Ÿæœ€ç»ˆè®¾ç½®æŒ‡å—

## ğŸ‰ æ­å–œï¼è¯„è®ºç³»ç»Ÿåç«¯å·²å®Œæˆå¼€å‘

æˆ‘å·²ç»æˆåŠŸä¸ºæ‚¨å®ç°äº†åŸºäº Supabase çš„å®Œæ•´è¯„è®ºç³»ç»Ÿåç«¯ã€‚ä»¥ä¸‹æ˜¯æœ€ç»ˆçš„è®¾ç½®å’Œä½¿ç”¨æŒ‡å—ã€‚

## âœ… å·²å®ç°çš„åŠŸèƒ½

### æ ¸å¿ƒåŠŸèƒ½
- âœ… **è¯„è®ºæäº¤**: æ”¯æŒå§“åã€é‚®ç®±ã€å†…å®¹è¾“å…¥
- âœ… **è¯„è®ºå›å¤**: æ”¯æŒå¤šçº§å›å¤åŠŸèƒ½
- âœ… **è¯„è®ºæŠ•ç¥¨**: ç‚¹èµ/ç‚¹è¸©ï¼ŒåŸºäºIPé˜²åˆ·
- âœ… **åˆ†é¡µæ˜¾ç¤º**: æ¯é¡µ5æ¡è¯„è®ºï¼Œæ”¯æŒåŠ è½½æ›´å¤š
- âœ… **æ’åºåŠŸèƒ½**: æœ€æ–°ã€æœ€æ—§ã€æœ€å—æ¬¢è¿æ’åº
- âœ… **æ¸¸æˆéš”ç¦»**: ä¸åŒæ¸¸æˆé¡µé¢çš„è¯„è®ºåˆ†ç¦»

### æŠ€æœ¯ç‰¹æ€§
- âœ… **æ•°æ®åº“**: Supabase PostgreSQL
- âœ… **API**: Next.js API Routes
- âœ… **å®‰å…¨æ€§**: RLSç­–ç•¥ã€IPè®°å½•ã€é‚®ç®±éªŒè¯
- âœ… **æ€§èƒ½**: æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- âœ… **å‰ç«¯é›†æˆ**: ä¸ç°æœ‰JavaScriptä»£ç å®Œå…¨å…¼å®¹

## ğŸš€ å¿«é€Ÿè®¾ç½®æ­¥éª¤

### 1. è®¾ç½®æ•°æ®åº“

åœ¨ Supabase Dashboard çš„ SQL Editor ä¸­æ‰§è¡Œä»¥ä¸‹ SQLï¼š

```sql
-- æ·»åŠ ç¼ºå¤±å­—æ®µåˆ° comments è¡¨
ALTER TABLE comments ADD COLUMN IF NOT EXISTS parent_id BIGINT DEFAULT 0;
ALTER TABLE comments ADD COLUMN IF NOT EXISTS game_id VARCHAR(100) NOT NULL DEFAULT 'steal-brainrot';
ALTER TABLE comments ADD COLUMN IF NOT EXISTS status VARCHAR(20) NOT NULL DEFAULT 'approved' CHECK (status IN ('approved', 'pending', 'spam', 'trash'));
ALTER TABLE comments ADD COLUMN IF NOT EXISTS ip_address INET;
ALTER TABLE comments ADD COLUMN IF NOT EXISTS user_agent TEXT;
ALTER TABLE comments ADD COLUMN IF NOT EXISTS like_count INTEGER DEFAULT 0;
ALTER TABLE comments ADD COLUMN IF NOT EXISTS dislike_count INTEGER DEFAULT 0;
ALTER TABLE comments ADD COLUMN IF NOT EXISTS updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();

-- åˆ›å»º comment_votes è¡¨
CREATE TABLE IF NOT EXISTS comment_votes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  comment_id BIGINT NOT NULL REFERENCES comments(id) ON DELETE CASCADE,
  ip_address INET NOT NULL,
  vote_type VARCHAR(10) NOT NULL CHECK (vote_type IN ('like', 'dislike')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(comment_id, ip_address)
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_comments_game_id ON comments(game_id);
CREATE INDEX IF NOT EXISTS idx_comments_parent_id ON comments(parent_id);
CREATE INDEX IF NOT EXISTS idx_comment_votes_comment_id ON comment_votes(comment_id);

-- å¯ç”¨ RLS
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;
ALTER TABLE comment_votes ENABLE ROW LEVEL SECURITY;

-- åˆ›å»º RLS ç­–ç•¥
CREATE POLICY "Anyone can view approved comments" ON comments FOR SELECT USING (status = 'approved');
CREATE POLICY "Anyone can insert comments" ON comments FOR INSERT WITH CHECK (true);
CREATE POLICY "Anyone can view comment votes" ON comment_votes FOR SELECT USING (true);
CREATE POLICY "Anyone can insert comment votes" ON comment_votes FOR INSERT WITH CHECK (true);
```

### 2. éªŒè¯ç¯å¢ƒå˜é‡

ç¡®ä¿ `.env.local` æ–‡ä»¶åŒ…å«æ­£ç¡®çš„ Supabase é…ç½®ï¼š

```env
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### 3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
npm run dev
```

### 4. æµ‹è¯•ç³»ç»Ÿ

```bash
# è¿è¡ŒåŠŸèƒ½æµ‹è¯•
node scripts/standalone-test.js

# è¿è¡ŒAPIæµ‹è¯•
node scripts/test-api-endpoints.js
```

## ğŸ“ æ–‡ä»¶ç»“æ„

### API ç«¯ç‚¹
- `app/api/make-comment.ajax/route.js` - åˆ›å»ºè¯„è®ºAPI
- `app/api/comments.ajax/route.js` - è·å–è¯„è®ºAPI
- `app/api/comment-vote.ajax/route.js` - æŠ•ç¥¨API

### é…ç½®æ–‡ä»¶
- `lib/supabase.js` - Supabaseå®¢æˆ·ç«¯é…ç½®
- `lib/supabase-admin.js` - Supabaseç®¡ç†å‘˜å®¢æˆ·ç«¯é…ç½®

### è„šæœ¬å·¥å…·
- `scripts/standalone-test.js` - å®Œæ•´åŠŸèƒ½æµ‹è¯•
- `scripts/test-api-endpoints.js` - APIç«¯ç‚¹æµ‹è¯•
- `scripts/update-database-schema.js` - æ•°æ®åº“æ›´æ–°è„šæœ¬

### æ–‡æ¡£
- `DATABASE_SETUP_SQL.md` - æ•°æ®åº“è®¾ç½®SQLè„šæœ¬
- `TESTING_GUIDE.md` - è¯¦ç»†æµ‹è¯•æŒ‡å—

## ğŸ”§ API ä½¿ç”¨è¯´æ˜

### åˆ›å»ºè¯„è®º
```javascript
POST /api/make-comment.ajax
Content-Type: application/json

{
  "author": "ç”¨æˆ·å",
  "email": "user@example.com",
  "content": "è¯„è®ºå†…å®¹",
  "game_id": "steal-brainrot",
  "parent_id": 0  // å¯é€‰ï¼Œç”¨äºå›å¤
}
```

### è·å–è¯„è®º
```javascript
GET /api/comments.ajax?page=1&limit=5&sort=newest&game_id=steal-brainrot
```

### æŠ•ç¥¨
```javascript
POST /api/comment-vote.ajax
Content-Type: application/json

{
  "comment_id": 123,
  "vote_type": "like"  // æˆ– "dislike"
}
```

## ğŸ¯ å‰ç«¯é›†æˆ

è¯„è®ºç³»ç»Ÿå·²ç»ä¸ç°æœ‰çš„å‰ç«¯ä»£ç å®Œå…¨é›†æˆï¼š

1. **è¯„è®ºè¡¨å•**: åœ¨ `data/home-body.html` ä¸­
2. **JavaScriptå¤„ç†**: å·²æ›´æ–°ä¸ºä½¿ç”¨æ–°çš„APIç«¯ç‚¹
3. **UIç»„ä»¶**: ä¿æŒåŸæœ‰çš„ç”¨æˆ·ç•Œé¢å’Œä½“éªŒ

## ğŸ” åŠŸèƒ½éªŒè¯

### åŸºæœ¬åŠŸèƒ½æ£€æŸ¥æ¸…å•

- [ ] è®¿é—®é¦–é¡µï¼Œçœ‹åˆ°è¯„è®ºåŒºåŸŸ
- [ ] å¡«å†™è¯„è®ºè¡¨å•å¹¶æäº¤
- [ ] çœ‹åˆ°æ–°è¯„è®ºå‡ºç°åœ¨åˆ—è¡¨ä¸­
- [ ] ç‚¹å‡»å›å¤æŒ‰é’®ï¼Œå¯ä»¥å›å¤è¯„è®º
- [ ] ç‚¹å‡»ç‚¹èµ/ç‚¹è¸©æŒ‰é’®
- [ ] ä½¿ç”¨æ’åºåŠŸèƒ½ï¼ˆæœ€æ–°ã€æœ€æ—§ã€æœ€å—æ¬¢è¿ï¼‰
- [ ] ä½¿ç”¨åˆ†é¡µåŠŸèƒ½åŠ è½½æ›´å¤šè¯„è®º

### APIå“åº”ç¤ºä¾‹

**æˆåŠŸåˆ›å»ºè¯„è®º**:
```json
{
  "success": true,
  "comment": {
    "id": 123,
    "author": "ç”¨æˆ·å",
    "content": "è¯„è®ºå†…å®¹",
    "date": "2025-01-11",
    "status": "approved",
    "parent_id": 0
  }
}
```

**è·å–è¯„è®ºåˆ—è¡¨**:
```json
{
  "success": true,
  "comments": [...],
  "pagination": {
    "page": 1,
    "limit": 5,
    "total": 25,
    "totalPages": 5
  }
}
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç¯å¢ƒå˜é‡é”™è¯¯**
   ```
   Error: Missing Supabase environment variables
   ```
   **è§£å†³**: æ£€æŸ¥ `.env.local` æ–‡ä»¶ä¸­çš„å˜é‡é…ç½®

2. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   ```
   Could not find the table 'public.comments'
   ```
   **è§£å†³**: åœ¨ Supabase Dashboard æ‰§è¡Œä¸Šè¿° SQL è„šæœ¬

3. **APIè¯·æ±‚å¤±è´¥**
   ```
   500 Internal Server Error
   ```
   **è§£å†³**: æ£€æŸ¥ Supabase é¡¹ç›®çŠ¶æ€å’Œæƒé™è®¾ç½®

4. **å‰ç«¯æ˜¾ç¤ºé”™è¯¯**
   ```
   jQuery is not defined
   ```
   **è§£å†³**: ç¡®ä¿ jQuery å·²æ­£ç¡®åŠ è½½

## ğŸ‰ å®Œæˆç¡®è®¤

å½“æ‚¨å®Œæˆä»¥ä¸‹æ­¥éª¤åï¼Œç³»ç»Ÿå°±å®Œå…¨å¯ç”¨äº†ï¼š

1. âœ… æ‰§è¡Œäº†æ•°æ®åº“è®¾ç½®SQL
2. âœ… ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
3. âœ… å¼€å‘æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨
4. âœ… æµ‹è¯•è„šæœ¬è¿è¡ŒæˆåŠŸ
5. âœ… å¯ä»¥åœ¨ç½‘ç«™ä¸Šå‘è¡¨è¯„è®º

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœæ‚¨åœ¨è®¾ç½®è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ï¼š

1. æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯
2. è¿è¡Œæµ‹è¯•è„šæœ¬è¿›è¡Œè¯Šæ–­
3. æ£€æŸ¥ Supabase Dashboard çš„é¡¹ç›®çŠ¶æ€
4. éªŒè¯ç½‘ç»œè¿æ¥å’Œæƒé™è®¾ç½®

---

**ğŸŠ æ­å–œï¼æ‚¨çš„è¯„è®ºç³»ç»Ÿç°åœ¨å·²ç»å®Œå…¨å¯ç”¨äº†ï¼**