# Design Document - Supabase 评论系统后端

## Overview

本设计文档描述了基于 Supabase 的评论系统后端架构。系统使用 Next.js API Routes 作为后端接口，Supabase PostgreSQL 作为数据存储，实现评论的增删改查、投票和回复功能。

系统采用 RESTful API 设计，支持多游戏页面的评论隔离，并通过 Supabase RLS 确保数据安全。

## Architecture

### 系统架构图

```
┌─────────────────┐
│   前端页面       │
│  (React/Next.js) │
└────────┬────────┘
         │ HTTP Requests
         ▼
┌─────────────────┐
│  API Routes     │
│  (Next.js)      │
│  - comments     │
│  - make-comment │
│  - comment-vote │
└────────┬────────┘
         │ Supabase Client
         ▼
┌─────────────────┐
│   Supabase      │
│  - PostgreSQL   │
│  - RLS Policies │
│  - Indexes      │
└─────────────────┘
```

### 技术栈

- **前端**: Next.js 14+ (App Router)
- **后端**: Next.js API Routes
- **数据库**: Supabase PostgreSQL
- **认证**: 基于 IP 地址的投票限制
- **部署**: Vercel / 其他 Node.js 平台

## Components and Interfaces

### 1. API Routes

#### GET /api/comments.ajax

获取评论列表

**Query Parameters:**
```typescript
{
  page?: number;        // 页码，默认 1
  limit?: number;       // 每页数量，默认 5
  sort?: 'newest' | 'oldest' | 'popular';  // 排序方式
  game_id?: string;     // 游戏 ID，默认 'steal-brainrot'
}
```

**Response:**
```typescript
{
  success: boolean;
  comments: Comment[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  }
}
```

#### POST /api/make-comment.ajax

提交新评论

**Request Body:**
```typescript
{
  author: string;       // 用户名
  email: string;        // 邮箱
  content: string;      // 评论内容
  parent_id?: number;   // 父评论 ID，默认 0
  game_id?: string;     // 游戏 ID
}
```

**Response:**
```typescript
{
  success: boolean;
  comment?: {
    id: number;
    author: string;
    content: string;
    date: string;
    status: string;
    parent_id: number;
  };
  error?: string;
}
```

#### POST /api/comment-vote.ajax

评论投票

**Request Body:**
```typescript
{
  comment_id: number;
  vote_type: 'like' | 'dislike';
}
```

**Response:**
```typescript
{
  success: boolean;
  vote_result: {
    action: 'added' | 'removed' | 'changed';
    vote_type?: string;
    from?: string;
    to?: string;
  };
  counts: {
    like: number;
    dislike: number;
  };
  error?: string;
}
```

### 2. Supabase Client 配置

```typescript
// lib/supabase.js
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY

export const supabase = createClient(supabaseUrl, supabaseAnonKey)
```

对于需要绕过 RLS 的服务器端操作，使用 Service Role Key：

```typescript
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY,
  {
    auth: {
      autoRefreshToken: false,
      persistSession: false
    }
  }
)
```

## Data Models

### Comments Table

```sql
CREATE TABLE comments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  author VARCHAR(100) NOT NULL,
  email VARCHAR(255) NOT NULL,
  content TEXT NOT NULL,
  parent_id BIGINT DEFAULT 0,
  game_id VARCHAR(100) NOT NULL DEFAULT 'steal-brainrot',
  status VARCHAR(20) NOT NULL DEFAULT 'approved',
  ip_address INET,
  user_agent TEXT,
  like_count INTEGER DEFAULT 0,
  dislike_count INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**字段说明:**
- `id`: 主键，自增
- `author`: 评论者姓名
- `email`: 评论者邮箱
- `content`: 评论内容
- `parent_id`: 父评论 ID，0 表示顶级评论
- `game_id`: 游戏标识符，用于区分不同游戏页面
- `status`: 评论状态 (approved/pending/spam/trash)
- `ip_address`: 用户 IP 地址
- `user_agent`: 用户代理字符串
- `like_count`: 点赞数
- `dislike_count`: 点踩数
- `created_at`: 创建时间
- `updated_at`: 更新时间

### Comment Votes Table

```sql
CREATE TABLE comment_votes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  comment_id BIGINT NOT NULL REFERENCES comments(id) ON DELETE CASCADE,
  ip_address INET NOT NULL,
  vote_type VARCHAR(10) NOT NULL CHECK (vote_type IN ('like', 'dislike')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(comment_id, ip_address)
);
```

**字段说明:**
- `id`: 主键，自增
- `comment_id`: 关联的评论 ID
- `ip_address`: 投票用户的 IP 地址
- `vote_type`: 投票类型 (like/dislike)
- `created_at`: 投票时间
- `UNIQUE(comment_id, ip_address)`: 确保每个 IP 对每条评论只能投一票

### TypeScript 类型定义

```typescript
interface Comment {
  id: number;
  author: string;
  email: string;
  content: string;
  parent_id: number;
  game_id: string;
  status: 'approved' | 'pending' | 'spam' | 'trash';
  ip_address?: string;
  user_agent?: string;
  like_count: number;
  dislike_count: number;
  created_at: string;
  updated_at: string;
  date?: string;  // 格式化后的日期
  replies?: Comment[];  // 回复列表
}

interface CommentVote {
  id: number;
  comment_id: number;
  ip_address: string;
  vote_type: 'like' | 'dislike';
  created_at: string;
}
```

## Error Handling

### API 错误响应格式

所有 API 在出错时返回统一格式：

```typescript
{
  success: false,
  error: string  // 错误描述
}
```

### HTTP 状态码

- `200`: 成功
- `400`: 客户端请求错误（缺少参数、格式错误等）
- `500`: 服务器内部错误

### 错误处理策略

1. **输入验证错误**: 返回 400 状态码和具体错误信息
2. **数据库错误**: 记录到控制台，返回 500 和通用错误信息
3. **网络错误**: 捕获并返回 500 状态码

### 日志记录

```typescript
console.error('API error:', error)
console.log('请求数据:', { author, email, content })
```

## Testing Strategy

### 1. 单元测试

测试各个 API 端点的核心逻辑：

- 输入验证逻辑
- 数据转换逻辑
- 错误处理逻辑

### 2. 集成测试

测试 API 与 Supabase 的集成：

- 评论创建和查询
- 投票功能
- 分页和排序
- 回复功能

### 3. 端到端测试

测试完整的用户流程：

- 提交评论 → 查看评论列表
- 投票 → 验证计数更新
- 回复评论 → 验证回复显示

### 4. 性能测试

- 大量评论的加载性能
- 并发投票的处理
- 数据库查询优化验证

### 测试工具

- Jest: 单元测试
- Supertest: API 测试
- Playwright: 端到端测试

## Database Optimization

### 索引策略

```sql
-- 游戏 ID 索引（最常用的查询条件）
CREATE INDEX idx_comments_game_id ON comments(game_id);

-- 父评论 ID 索引（用于查询回复）
CREATE INDEX idx_comments_parent_id ON comments(parent_id);

-- 状态索引（用于过滤已批准的评论）
CREATE INDEX idx_comments_status ON comments(status);

-- 创建时间索引（用于排序）
CREATE INDEX idx_comments_created_at ON comments(created_at);

-- 投票表索引
CREATE INDEX idx_comment_votes_comment_id ON comment_votes(comment_id);
CREATE INDEX idx_comment_votes_ip_address ON comment_votes(ip_address);
```

### 查询优化

1. **分页查询**: 使用 `range()` 方法而不是 `limit/offset`
2. **关联查询**: 一次性加载父评论和回复，减少数据库往返
3. **计数优化**: 使用 `count: 'exact'` 选项获取总数

### RLS 策略

```sql
-- 允许所有用户读取已批准的评论
CREATE POLICY "Anyone can view approved comments" ON comments
    FOR SELECT USING (status = 'approved');

-- 允许所有用户插入评论
CREATE POLICY "Anyone can insert comments" ON comments
    FOR INSERT WITH CHECK (true);

-- 投票表策略
CREATE POLICY "Anyone can view comment votes" ON comment_votes 
    FOR SELECT USING (true);
    
CREATE POLICY "Anyone can insert comment votes" ON comment_votes 
    FOR INSERT WITH CHECK (true);
```

## Security Considerations

### 3. IP 地址记录

- 记录评论者和投票者的 IP 地址
- 用于防止滥用和垃圾评论
- 基于 IP 限制投票


## Deployment

### 环境变量配置

在部署平台（如 Vercel）配置以下环境变量：

```env
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### 数据库初始化

1. 在 Supabase Dashboard 执行 `supabase/comments_table.sql`
2. 验证表和索引创建成功
3. 测试 RLS 策略

### 部署检查清单

- [ ] 环境变量已配置
- [ ] 数据库表已创建
- [ ] RLS 策略已启用
- [ ] API 端点可访问
- [ ] 评论提交功能正常
- [ ] 投票功能正常
- [ ] 分页和排序正常

## Future Enhancements

1. **实时更新**: 使用 Supabase Realtime 实现评论实时更新
2. **富文本编辑**: 支持 Markdown 或富文本格式
3. **用户认证**: 集成 Supabase Auth 实现用户登录
4. **评论审核**: 添加管理后台进行评论审核
5. **垃圾评论过滤**: 集成 Akismet 或关键词过滤
6. **邮件通知**: 评论回复时发送邮件通知
7. **图片上传**: 支持在评论中上传图片
8. **评论搜索**: 实现评论内容搜索功能
