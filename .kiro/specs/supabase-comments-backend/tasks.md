# Implementation Plan

- [ ] 1. 验证和完善 Supabase 配置
  - 检查环境变量是否正确配置
  - 验证 Supabase 客户端连接
  - 确认数据库表已创建并包含所需索引
  - _Requirements: 7.1, 7.2, 7.3_

- [ ] 2. 完善评论提交 API (make-comment.ajax)
  - [ ] 2.1 优化环境变量加载，移除硬编码的凭证
    - 使用环境变量而不是硬编码的 Supabase URL 和密钥
    - 添加环境变量缺失时的错误处理
    - _Requirements: 1.3_

  - [ ] 2.2 实现 parent_id 支持以处理回复评论
    - 确保 parent_id 参数正确传递到数据库
    - 验证父评论存在性（可选）
    - _Requirements: 6.2_

  - [ ] 2.3 添加 user_agent 记录
    - 从请求头获取 user_agent
    - 存储到数据库的 user_agent 字段
    - _Requirements: 1.3_

- [ ] 3. 完善评论查询 API (comments.ajax)
  - [ ] 3.1 优化回复评论的加载逻辑
    - 确保回复按创建时间升序排列
    - 优化查询性能，减少数据库往返
    - _Requirements: 2.4, 6.3, 6.5_

  - [ ] 3.2 添加错误处理和日志
    - 记录查询错误到控制台
    - 返回友好的错误消息
    - _Requirements: 2.1_

  - [ ] 3.3 验证分页功能
    - 确认每页显示 5 条评论
    - 验证分页信息计算正确
    - _Requirements: 2.3, 2.5_

- [ ] 4. 完善投票 API (comment-vote.ajax)
  - [ ] 4.1 修复环境变量使用
    - 使用正确的环境变量名称
    - 添加环境变量验证
    - _Requirements: 3.1, 3.4_

  - [ ] 4.2 优化投票逻辑
    - 确保取消投票功能正常工作
    - 确保更改投票类型功能正常工作
    - _Requirements: 3.2, 3.3_

  - [ ] 4.3 实时更新评论计数
    - 在投票后立即更新 comments 表的 like_count 和 dislike_count
    - 确保计数准确反映 comment_votes 表的数据
    - _Requirements: 3.5_

- [ ] 5. 实现前端集成
  - [ ] 5.1 创建评论表单组件
    - 实现姓名、邮箱、内容输入字段
    - 添加表单验证
    - 调用 make-comment.ajax API
    - _Requirements: 1.1, 1.3, 1.4_

  - [ ] 5.2 创建评论列表组件
    - 显示评论列表
    - 实现排序功能（最新、最旧、最受欢迎）
    - 实现分页控件
    - _Requirements: 2.1, 2.2, 2.3, 2.5_

  - [ ] 5.3 创建回复功能组件
    - 添加回复按钮
    - 显示回复表单
    - 在父评论下显示回复
    - _Requirements: 6.1, 6.2, 6.3_

  - [ ] 5.4 创建投票按钮组件
    - 实现点赞和点踩按钮
    - 显示投票计数
    - 处理投票状态变化
    - _Requirements: 3.1, 3.2, 3.3, 3.5_

  - [ ] 5.5 集成 game_id 参数
    - 根据当前页面自动设置 game_id
    - 确保评论与游戏页面正确关联
    - _Requirements: 7.1, 7.2, 7.3_

- [ ] 6. 数据库优化验证
  - [ ] 6.1 验证索引已创建
    - 检查 game_id、parent_id、status、created_at 索引
    - 检查 comment_votes 表的索引
    - _Requirements: 7.1, 2.1_

  - [ ] 6.2 验证 RLS 策略
    - 测试匿名用户只能查看已批准的评论
    - 测试评论插入权限
    - 测试投票权限
    - _Requirements: 2.1, 1.3, 3.1_

- [ ] 7. 端到端测试
  - [ ] 7.1 测试评论提交流程
    - 提交新评论
    - 验证评论出现在列表中
    - _Requirements: 1.3, 1.4, 2.1_

  - [ ] 7.2 测试回复功能
    - 点击回复按钮
    - 提交回复
    - 验证回复显示在父评论下
    - _Requirements: 6.1, 6.2, 6.3_

  - [ ] 7.3 测试投票功能
    - 点击点赞按钮
    - 验证计数增加
    - 再次点击验证取消投票
    - 点击点踩验证更改投票类型
    - _Requirements: 3.1, 3.2, 3.3, 3.5_

  - [ ] 7.4 测试分页和排序
    - 验证分页控件正常工作
    - 测试不同排序选项
    - _Requirements: 2.2, 2.3, 2.5_

  - [ ] 7.5 测试多游戏页面隔离
    - 在不同游戏页面提交评论
    - 验证评论只显示在对应页面
    - _Requirements: 7.1, 7.2, 7.3_
